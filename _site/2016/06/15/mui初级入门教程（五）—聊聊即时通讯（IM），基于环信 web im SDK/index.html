<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK | 小青年博客 | 看似寻常最奇崛，成如容易却艰辛。</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="mui,html5plus,环信,im,页面传值,缓存">
    <meta name="description" content="写在前面感觉自从qq、微信这种APP用多了，现在都没啥人发短信了，现在什么APP都想加入IM的功能，曾经有段时间在折腾自己撸一个聊天的东西，也尝试过很多平台，今天这里给大家介绍一下从零开始自己做一个聊天的app功能。因为之前帮朋友做过一个基于环信的聊天功能，这里就以环信的平台为例举个例子说明。这篇文章注意想讲解一下集成这种第三方的一般实现方法，不会一下子就把所有的功能都集成，因为之前做环信主要是在">
<meta name="keywords" content="mui,html5plus,环信,im,页面传值,缓存">
<meta property="og:type" content="article">
<meta property="og:title" content="mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK">
<meta property="og:url" content="https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/index.html">
<meta property="og:site_name" content="小青年博客">
<meta property="og:description" content="写在前面感觉自从qq、微信这种APP用多了，现在都没啥人发短信了，现在什么APP都想加入IM的功能，曾经有段时间在折腾自己撸一个聊天的东西，也尝试过很多平台，今天这里给大家介绍一下从零开始自己做一个聊天的app功能。因为之前帮朋友做过一个基于环信的聊天功能，这里就以环信的平台为例举个例子说明。这篇文章注意想讲解一下集成这种第三方的一般实现方法，不会一下子就把所有的功能都集成，因为之前做环信主要是在">
<meta property="og:image" content="http://oo1uw74rb.bkt.clouddn.com/20160615002.png">
<meta property="og:image" content="https://segmentfault.com/img/bVycIN">
<meta property="og:updated_time" content="2017-05-03T16:15:32.882Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK">
<meta name="twitter:description" content="写在前面感觉自从qq、微信这种APP用多了，现在都没啥人发短信了，现在什么APP都想加入IM的功能，曾经有段时间在折腾自己撸一个聊天的东西，也尝试过很多平台，今天这里给大家介绍一下从零开始自己做一个聊天的app功能。因为之前帮朋友做过一个基于环信的聊天功能，这里就以环信的平台为例举个例子说明。这篇文章注意想讲解一下集成这种第三方的一般实现方法，不会一下子就把所有的功能都集成，因为之前做环信主要是在">
<meta name="twitter:image" content="http://oo1uw74rb.bkt.clouddn.com/20160615002.png">
    
        <link rel="alternate" type="application/atom+xml" title="小青年博客" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">赵梦欢</h5>
          <a href="mailto:zhaomenghuan@foxmail.com" title="zhaomenghuan@foxmail.com" class="mail">zhaomenghuan@foxmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://zhaomenghuan.github.io/content.json" target="_blank" >
                <i class="icon icon-lg icon-th-large"></i>
                API
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/zhaomenghuan" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                GitHub
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://segmentfault.com/u/zhaomenghuan" target="_blank" >
                <i class="icon icon-lg icon-link"></i>
                Segmentfault
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://www.jianshu.com/u/de1f0b8eaf18" target="_blank" >
                <i class="icon icon-lg icon-book"></i>
                简书
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK</h1>
        <h5 class="subtitle">
            
                <time datetime="2016-06-14T16:00:00.000Z" itemprop="datePublished" class="page-time">
  2016-06-15
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/MUI从入门到精通/">MUI从入门到精通</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#写在前面"><span class="post-toc-number">1.</span> <span class="post-toc-text">写在前面</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#准备工作"><span class="post-toc-number">2.</span> <span class="post-toc-text">准备工作</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-注册账号"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.注册账号</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-下载SDK"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2.下载SDK</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-开发文档"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">3.开发文档</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#项目实战"><span class="post-toc-number">3.</span> <span class="post-toc-text">项目实战</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-用户注册功能"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">1.用户注册功能</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-用户登录功能"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.用户登录功能</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#实例化new-Easemob-im-Connection-建立连接"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">实例化new Easemob.im.Connection()建立连接</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#工具类Easemob-im-Helper-login2UserGrid-options-建立连接"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">工具类Easemob.im.Helper.login2UserGrid(options)建立连接</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-页面传参深入探究"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">3.页面传参深入探究</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#拓展参数extras传值"><span class="post-toc-number">3.3.1.</span> <span class="post-toc-text">拓展参数extras传值</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#预加载时使用mui-fire-传值"><span class="post-toc-number">3.3.2.</span> <span class="post-toc-text">预加载时使用mui.fire()传值</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-获取好友列表及添加好友"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">4.获取好友列表及添加好友</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#获取好友列表"><span class="post-toc-number">3.4.1.</span> <span class="post-toc-text">获取好友列表</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#添加好友"><span class="post-toc-number">3.4.2.</span> <span class="post-toc-text">添加好友</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-数据绑定和本地缓存处理机制"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">5.数据绑定和本地缓存处理机制</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-聊天消息封装"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">6.聊天消息封装</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#7-单聊之文本消息"><span class="post-toc-number">3.7.</span> <span class="post-toc-text">7.单聊之文本消息</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#基本思路"><span class="post-toc-number">3.7.1.</span> <span class="post-toc-text">基本思路</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#获得输入框焦点事件和强制弹出软键盘"><span class="post-toc-number">3.7.2.</span> <span class="post-toc-text">获得输入框焦点事件和强制弹出软键盘</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#聊天消息高度调整"><span class="post-toc-number">3.7.3.</span> <span class="post-toc-text">聊天消息高度调整</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#输入框高度如何自适应"><span class="post-toc-number">3.7.4.</span> <span class="post-toc-text">输入框高度如何自适应</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#解决长按导致致键盘关闭的问题"><span class="post-toc-number">3.7.5.</span> <span class="post-toc-text">解决长按导致致键盘关闭的问题</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#写在后面"><span class="post-toc-number">4.</span> <span class="post-toc-text">写在后面</span></a></li></ol>
        </nav>
    </aside>
    
<article id="post-mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK</h1>
        <div class="post-meta">
            <time class="post-time" title="2016-06-15 00:00:00" datetime="2016-06-14T16:00:00.000Z"  itemprop="datePublished">2016-06-15</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/MUI从入门到精通/">MUI从入门到精通</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>感觉自从<code>qq</code>、微信这种<code>APP</code>用多了，现在都没啥人发短信了，现在什么<code>APP</code>都想加入<code>IM</code>的功能，曾经有段时间在折腾自己撸一个聊天的东西，也尝试过很多平台，今天这里给大家介绍一下从零开始自己做一个聊天的<code>app</code>功能。因为之前帮朋友做过一个基于环信的聊天功能，这里就以环信的平台为例举个例子说明。这篇文章注意想讲解一下集成这种第三方的一般实现方法，不会一下子就把所有的功能都集成，因为之前做环信主要是在微信上用，所以用的是环信的<code>Web IM</code>，遇到了蛮多坑，这次打算用<code>dcloud</code>这边的<code>mui</code>重新集成，所以在没有完全做完之前，所以也不知道有些坑具体能够在有限的时间内解决，本文仅供参考，欢迎大家去实践检验。在写这篇文章之前先贴一个<code>Dcloud</code>论坛中的资源帖，<a href="http://ask.dcloud.net.cn/article/649" target="_blank" rel="external">【即时通信、im问题汇总】</a></p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="1-注册账号"><a href="#1-注册账号" class="headerlink" title="1.注册账号"></a>1.注册账号</h3><p>我们要先去<a href="http://www.easemob.com/product/im" target="_blank" rel="external">环信官网</a>注册一个账号，然后在后台创建一个应用，因为我们后面在做功能的时候可以用后面发送消息及图片来测试收消息，用户管理在后台也可以看得一清二楚。</p>
{% image http://oo1uw74rb.bkt.clouddn.com/20160615001.png '环信官网' '' %}
<p>创建成功后找到应用标识(AppKey)，这个在后期配置中会用到。</p>
<h3 id="2-下载SDK"><a href="#2-下载SDK" class="headerlink" title="2.下载SDK"></a>2.下载SDK</h3><p><a href="http://www.easemob.com/download/im" target="_blank" rel="external">http://www.easemob.com/download/im</a><br>这里我们使用的是<code>Web IM</code>，所以下载的<code>SDK</code>是<code>Web IM</code>版本，下载之后我们会看到一个演示<code>demo</code>,由于这个是<code>pc</code>版本，和我们需求不一致，所以我们只需要关心<code>sdk</code>目录下的文件和sdk集成需要修改的配置文件<code>easemob.im.config.js</code>。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">|---README.MD：</div><div class="line">|---index.html：demo首页，包含sdk基础功能和浏览器兼容性的解决方案</div><div class="line"></div><div class="line">|---<span class="keyword">static</span>/：</div><div class="line">	js/：</div><div class="line">		easemob.im.config.js：sdk集成需要修改的配置文件</div><div class="line">	css/：</div><div class="line">	img/：</div><div class="line">	sdk/：<span class="comment">/*sdk相关文件*/</span></div><div class="line">		release.txt：各版本更新细节</div><div class="line">		quickstart.md：环信WebIM快速入门文档</div><div class="line">		easemob.im<span class="number">-1.1</span>.js：js sdk</div><div class="line">		easemob.im<span class="number">-1.1</span>.shim.js：支持老版本sdk api</div><div class="line">		strophe.js：sdk依赖脚本</div></pre></td></tr></table></figure></p>
<h3 id="3-开发文档"><a href="#3-开发文档" class="headerlink" title="3.开发文档"></a>3.开发文档</h3><p>Web IM 介绍 <a href="http://docs.easemob.com/im/400webimintegration/10webimintro" target="_blank" rel="external">http://docs.easemob.com/im/400webimintegration/10webimintro</a></p>
<h2 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战"></a>项目实战</h2><p>由于这篇重在在于如何使用第三方开发<code>IM</code>，感觉说再多也诶有意义，直接上代码说明。不讲解过多的原理、细节，只讲究开发流程。</p>
<h3 id="1-用户注册功能"><a href="#1-用户注册功能" class="headerlink" title="1.用户注册功能"></a>1.用户注册功能</h3><p>首先我们在hbuilder中先新建一个项目<code>easemobIM</code>,然后把环信<code>sdk</code>文件夹和配置文件拷贝到我们的工程中。为了节约时间，下面的功能演示我是根据官方登录模板改的。<br><strong>html/reg.html</strong><br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"../css/mui.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"../css/style.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></div><div class="line">			.mui-input-group:first-child &#123;</div><div class="line">				margin-top: 20px;</div><div class="line">			&#125;</div><div class="line">			.mui-input-group label &#123;</div><div class="line">				width: 22%;</div><div class="line">			&#125;</div><div class="line">			.mui-input-row label~input,</div><div class="line">			.mui-input-row label~select,</div><div class="line">			.mui-input-row label~textarea &#123;</div><div class="line">				width: 78%;</div><div class="line">			&#125;</div><div class="line">			.mui-checkbox input[type=checkbox],</div><div class="line">			.mui-radio input[type=radio] &#123;</div><div class="line">				top: 6px;</div><div class="line">			&#125;</div><div class="line">			.mui-content-padded &#123;</div><div class="line">				margin-top: 25px;</div><div class="line">			&#125;</div><div class="line">			.mui-btn &#123;</div><div class="line">				padding: 10px;</div><div class="line">			&#125;</div><div class="line">		<span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">"mui-bar mui-bar-nav"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"mui-action-back mui-icon mui-icon-left-nav mui-pull-left"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"mui-title"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">header</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mui-content"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"mui-input-group"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mui-input-row"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">label</span>&gt;</span>手机<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">'username'</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"mui-input-clear mui-input"</span> <span class="attr">placeholder</span>=<span class="string">"请输入手机号码"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mui-input-row"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">label</span>&gt;</span>昵称<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">'nickname'</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"mui-input-clear mui-input"</span> <span class="attr">placeholder</span>=<span class="string">"请输入昵称"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mui-input-row"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">label</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">'password'</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"mui-input-clear mui-input"</span> <span class="attr">placeholder</span>=<span class="string">"请输入密码"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mui-input-row"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">label</span>&gt;</span>确认<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">'password_confirm'</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"mui-input-clear mui-input"</span> <span class="attr">placeholder</span>=<span class="string">"请确认密码"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mui-content-padded"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">'reg'</span> <span class="attr">class</span>=<span class="string">"mui-btn mui-btn-block mui-btn-primary"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">		</div><div class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../js/mui.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">		<span class="comment">&lt;!--sdk--&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../sdk/strophe.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../sdk/easemob.im-1.1.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../sdk/easemob.im-1.1.shim.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="comment">&lt;!--兼容老版本sdk需引入此文件--&gt;</span></div><div class="line">		<span class="comment">&lt;!--config--&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../js/easemob.im.config.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">			mui.init();</div><div class="line">			</div><div class="line">			<span class="comment">// 输入参数</span></div><div class="line">			<span class="keyword">var</span> regConfig = &#123;</div><div class="line">				<span class="attr">username</span>: mui(<span class="string">"#username"</span>)[<span class="number">0</span>],</div><div class="line">				<span class="attr">nickname</span>: mui(<span class="string">"#nickname"</span>)[<span class="number">0</span>],</div><div class="line">				<span class="attr">password</span>: mui(<span class="string">"#password"</span>)[<span class="number">0</span>],</div><div class="line">				<span class="attr">passwordConfirm</span>: mui(<span class="string">"#password_confirm"</span>)[<span class="number">0</span>]</div><div class="line">			&#125;;		</div><div class="line">			</div><div class="line">			<span class="comment">// 注册事件监听</span></div><div class="line">			mui(<span class="string">"#reg"</span>)[<span class="number">0</span>].addEventListener(<span class="string">'tap'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">				<span class="keyword">var</span> username = regConfig.username.value;</div><div class="line">				<span class="keyword">var</span> nickname = regConfig.nickname.value;</div><div class="line">				<span class="keyword">var</span> password = regConfig.password.value;</div><div class="line">				<span class="keyword">var</span> passwordConfirm = regConfig.passwordConfirm.value;</div><div class="line">				</div><div class="line">				<span class="comment">// 电话号码校验</span></div><div class="line">				<span class="keyword">if</span> (!isMobile(username))&#123;</div><div class="line">	                mui.toast(<span class="string">"电话号码格式不正确"</span>);</div><div class="line">	                <span class="keyword">return</span>;</div><div class="line">	            &#125;</div><div class="line">				<span class="comment">// 昵称非空校验</span></div><div class="line">				<span class="keyword">if</span> (!isEmpty(nickname))&#123;</div><div class="line">					mui.toast(<span class="string">'昵称不能为空'</span>);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 密码非空校验</span></div><div class="line">				<span class="keyword">if</span> (!isEmpty(password))&#123;</div><div class="line">					mui.toast(<span class="string">'密码不能为空'</span>);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 密码重复校验</span></div><div class="line">				<span class="keyword">if</span> (passwordConfirm != password) &#123;</div><div class="line">					mui.toast(<span class="string">'密码两次输入不一致'</span>);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line">               <span class="comment">// 环信SDK注册</span></div><div class="line">				<span class="keyword">var</span> options = &#123;</div><div class="line">					<span class="attr">username</span> : username,</div><div class="line">					<span class="attr">password</span> : password,</div><div class="line">					<span class="attr">nickname</span> : nickname,</div><div class="line">					<span class="attr">appKey</span> : Easemob.im.config.appkey,</div><div class="line">					<span class="attr">success</span> : <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</div><div class="line">						<span class="comment">//注册成功;</span></div><div class="line">						<span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(result))</div><div class="line">						mui.toast(<span class="string">'注册成功'</span>);</div><div class="line">					&#125;,</div><div class="line">					<span class="attr">error</span> : <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">						<span class="comment">//注册失败;</span></div><div class="line">						<span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(e));</div><div class="line">						mui.toast(<span class="string">'注册失败：'</span>+e.error);</div><div class="line">					&#125;</div><div class="line">				&#125;;</div><div class="line">				Easemob.im.Helper.registerUser(options);</div><div class="line">				</div><div class="line">			&#125;);		</div><div class="line"></div><div class="line">			<span class="comment">// 是否为电话号码</span></div><div class="line">			<span class="function"><span class="keyword">function</span> <span class="title">isMobile</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">                <span class="keyword">var</span> validateReg = <span class="regexp">/0?(13|14|15|18)[0-9]&#123;9&#125;/</span>;</div><div class="line">				<span class="keyword">return</span> validateReg.test(value);</div><div class="line">            &#125;</div><div class="line">			</div><div class="line">			<span class="comment">// 是否为空</span></div><div class="line">			<span class="function"><span class="keyword">function</span> <span class="title">isEmpty</span>(<span class="params">value</span>)</span>&#123;</div><div class="line">				<span class="keyword">var</span> validateReg = <span class="regexp">/^\S+$/</span>;</div><div class="line">				<span class="keyword">return</span> validateReg.test(value);</div><div class="line">			&#125;</div><div class="line">		<span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p> 这是注册页面的代码，我们首先要引入环信的<code>sdk</code>和<code>easemob.im.config.js</code>，并且将<code>easemob.im.config.js</code>中的<code>appkey</code>换成自己的，然后根据用户名/密码/昵称注册环信 Web IM，提交注册的代码为:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> options = &#123;</div><div class="line">	<span class="attr">username</span> : username,</div><div class="line">	<span class="attr">password</span> : password,</div><div class="line">	<span class="attr">nickname</span> : nickname,</div><div class="line">	<span class="attr">appKey</span> : Easemob.im.config.appkey,</div><div class="line">	<span class="attr">success</span> : <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</div><div class="line">		<span class="comment">//注册成功;</span></div><div class="line">		<span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(result))</div><div class="line">		mui.toast(<span class="string">'注册成功'</span>);</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">error</span> : <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">		<span class="comment">//注册失败;</span></div><div class="line">		<span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(e));</div><div class="line">		mui.toast(<span class="string">'注册失败：'</span>+e.error);</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line">Easemob.im.Helper.registerUser(options);</div></pre></td></tr></table></figure></p>
<p>我们注册完了后可以在环信后台【IM用户】查看用户注册信息，我们我们用其他平台，只需要把这块的内容改成相应的内容就OK。</p>
<h3 id="2-用户登录功能"><a href="#2-用户登录功能" class="headerlink" title="2.用户登录功能"></a>2.用户登录功能</h3><p>有了注册页面的经验，我们写登录页面也很简单，页面布局脚本和其他与登录逻辑无关的代码我这里不贴了，大家在我最后给的地址上下载完整代码，这里只讲解基本基本思路。环信登录优两种方法，一种是通过实例化<code>new Easemob.im.Connection()</code>建立连接，一种是使用工具类<code>Easemob.im.Helper.login2UserGrid(options)</code>，我们刚刚注册就是使用了工具类，为了便于大家后面的学习，我们在这里把两种方法都说一下：</p>
<h4 id="实例化new-Easemob-im-Connection-建立连接"><a href="#实例化new-Easemob-im-Connection-建立连接" class="headerlink" title="实例化new Easemob.im.Connection()建立连接"></a>实例化<code>new Easemob.im.Connection()</code>建立连接</h4><p><strong>1.创建连接</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> conn = <span class="keyword">new</span> Easemob.im.Connection();</div></pre></td></tr></table></figure></p>
<p><strong>2.初始化连接</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">conn.init(&#123;</div><div class="line">  <span class="attr">onOpened</span> : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">     alert(<span class="string">"成功登录"</span>);</div><div class="line">     conn.setPresence();</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p><strong>3.初始化连接</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 打开连接</span></div><div class="line">conn.open(&#123;</div><div class="line">   <span class="attr">user</span> : username,</div><div class="line">   <span class="attr">pwd</span> : password,</div><div class="line">   <span class="attr">appKey</span> : Easemob.im.config.appkey</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<blockquote>
<p>这里我们需要注意的是<code>open()</code>方法中需要配置的属性是<code>user</code>和<code>pwd</code>，这和我们注册时的有区别，要注意哦！</p>
</blockquote>
<p>这里需要说明的是<code>init()</code>是环信提供的一个通用的方法，比如后面我们要用到的接收文本消息、图片消息等一系列的回调方法都写在这个里面，<code>onOpened()</code>方法主要是用于当执行<code>conn.open()</code>方法时需要执行的方法，我们一般会把页面需要初始化的逻辑写在<code>onOpened()</code>中，比如查询好友。</p>
<p><strong>完整代码：</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 输入参数</span></div><div class="line"><span class="keyword">var</span> loginConfig = &#123;</div><div class="line">	<span class="attr">username</span>: mui(<span class="string">"#username"</span>)[<span class="number">0</span>],</div><div class="line">	<span class="attr">password</span>: mui(<span class="string">"#password"</span>)[<span class="number">0</span>]</div><div class="line">&#125;;	</div><div class="line"><span class="comment">// 创建一个新的连接</span></div><div class="line"><span class="keyword">var</span> conn = <span class="keyword">new</span> Easemob.im.Connection();</div><div class="line"><span class="comment">// 初始化连接</span></div><div class="line">conn.init(&#123;</div><div class="line">    <span class="attr">onOpened</span> : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        mui.toast(<span class="string">"成功登录"</span>);</div><div class="line">        conn.setPresence();</div><div class="line">        mui.openWindow(&#123;</div><div class="line">          <span class="attr">url</span>: <span class="string">'html/tab-webview-main.html'</span>,</div><div class="line">          <span class="attr">extras</span>:&#123;</div><div class="line">             <span class="attr">username</span>:loginConfig.username.value,</div><div class="line">             <span class="attr">password</span>:loginConfig.password.value</div><div class="line">	      &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"><span class="comment">// 登录事件监听</span></div><div class="line">mui(<span class="string">"#login"</span>)[<span class="number">0</span>].addEventListener(<span class="string">'tap'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> username = loginConfig.username.value;</div><div class="line">	<span class="keyword">var</span> password = loginConfig.password.value;</div><div class="line">	<span class="comment">// 电话号码校验</span></div><div class="line">	<span class="keyword">if</span> (!isMobile(username))&#123;</div><div class="line">	    mui.toast(<span class="string">"电话号码格式不正确"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">     &#125;</div><div class="line">	<span class="comment">// 密码非空校验</span></div><div class="line">	<span class="keyword">if</span> (!isEmpty(password))&#123;</div><div class="line">		mui.toast(<span class="string">'密码不能为空'</span>);</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 打开连接</span></div><div class="line">	conn.open(&#123;</div><div class="line">        <span class="attr">user</span> : username,</div><div class="line">        <span class="attr">pwd</span> : password,</div><div class="line">        <span class="attr">appKey</span> : Easemob.im.config.appkey</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="工具类Easemob-im-Helper-login2UserGrid-options-建立连接"><a href="#工具类Easemob-im-Helper-login2UserGrid-options-建立连接" class="headerlink" title="工具类Easemob.im.Helper.login2UserGrid(options)建立连接"></a>工具类<code>Easemob.im.Helper.login2UserGrid(options)</code>建立连接</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 登录</span></div><div class="line"><span class="keyword">var</span> options = &#123;</div><div class="line">    <span class="attr">user</span> : username,</div><div class="line">    <span class="attr">pwd</span> : password,</div><div class="line">    <span class="attr">appKey</span> : Easemob.im.config.appkey,</div><div class="line">    <span class="attr">success</span>:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</div><div class="line">    	<span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(data))</div><div class="line">    	mui.toast(<span class="string">"成功登录"</span>);</div><div class="line">        mui.openWindow(&#123;</div><div class="line">          <span class="attr">url</span>: <span class="string">'html/tab-webview-main.html'</span>,</div><div class="line">          <span class="attr">extras</span>:&#123;</div><div class="line">             <span class="attr">username</span>:loginConfig.username.value,</div><div class="line">             <span class="attr">password</span>:loginConfig.password.value</div><div class="line">	      &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">    	<span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(e))</div><div class="line">    	mui.toast(<span class="string">"成功失败:"</span>+e);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">Easemob.im.Helper.login2UserGrid(options);</div></pre></td></tr></table></figure>
<p>上面我们用了两种方法讲解了登录的方法，各有优劣，第二种只做登录的工作，代码也比较简洁，但是当我们的页面是多个页面时我们的登录状态是不能检测到的，这个时候我们还是需要在每个页面通过创建连接初始化，所以我们在页面跳转过程加入了拓展参数<code>extras</code>传递参数，然后在登陆后的页面接收就可以。</p>
<h3 id="3-页面传参深入探究"><a href="#3-页面传参深入探究" class="headerlink" title="3.页面传参深入探究"></a>3.页面传参深入探究</h3><p>为了尽可能简单的演示我们的功能，我这里不使用个性化的设计，就用官方模板组中的【mui底部选项卡（webview模式）】进行展示。新建模板文件如下：</p>
{% image http://i.imgur.com/JvDZUCk.png '' '' %}
<p>我们去掉第一个选项卡，只保留消息<code>tab-webview-subpage-chat.html</code>、通讯录<code>tab-webview-subpage-contact.html</code>、设置<code>tab-webview-subpage-setting.html</code>三个选项卡。</p>
<h4 id="拓展参数extras传值"><a href="#拓展参数extras传值" class="headerlink" title="拓展参数extras传值"></a>拓展参数<code>extras</code>传值</h4><p>上一小节中，我们在登陆页面通过拓展参数<code>extras</code>传值，在主页面接收数据的方法为：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mui.plusReady(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> self = plus.webview.currentWebview();</div><div class="line">    <span class="keyword">var</span> username = self.username;</div><div class="line">    <span class="keyword">var</span> password = self.password;</div><div class="line">    mui.toast(<span class="string">"username:"</span>+username+<span class="string">"&lt;br /&gt;"</span>+<span class="string">"password:"</span>+password);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>在主界面<code>mui.plusReady</code>方法里面拿到值，然后可以在创建子<code>webview</code>时候用拓展参数传值，然后在子页用下面的方法用同样的方法可以拿到值。但是其实我们不需要父页面向子页面发消息，直接在子页面通过这个找到父页面对象就OK了，如下：<br><strong>子页面代码：</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mui.plusReady(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> self = plus.webview.currentWebview().parent();</div><div class="line">    <span class="keyword">var</span> username = self.username;</div><div class="line">    <span class="keyword">var</span> password = self.password;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"username:"</span>+username+<span class="string">"password:"</span>+password);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="预加载时使用mui-fire-传值"><a href="#预加载时使用mui-fire-传值" class="headerlink" title="预加载时使用mui.fire()传值"></a>预加载时使用<code>mui.fire()</code>传值</h4><p>这里需要特别说明一下的是我们有时候想要预加载我们的主页面，这里我们有个地方我需要特别注意的是，我们需要用<code>mui.fire()</code>传递参数：</p>
<blockquote>
<p>mui.fire(target,event,data) </p>
</blockquote>
<p>特别提醒一下：<code>target</code>是需要接受参数的<code>webview</code>对象，而不是<code>id</code>，在这个地方我出过错误，当时一直没有察觉，如果是<code>id</code>，需要使用<code>plus.webview.getWebviewById(id)</code>进行转换。</p>
<p>比如我们在登陆页面使用<code>preload</code>预加载，代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">var mainPage = <span class="literal">null</span>;</div><div class="line">mui.plusReady(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	mainPage = mui.preload(&#123;</div><div class="line">		<span class="string">"url"</span>: <span class="string">'html/tab-webview-main.html'</span>,</div><div class="line">		<span class="string">"id"</span>: <span class="string">'main'</span></div><div class="line">	&#125;);</div><div class="line">&#125;)</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p><strong>登陆按钮监听事件中的success方法：</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">mui.fire(mainPage,<span class="string">'show'</span>,&#123;</div><div class="line">   	<span class="attr">username</span>:loginConfig.username.value,</div><div class="line">   	<span class="attr">password</span>:loginConfig.password.value</div><div class="line">&#125;);</div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	mui.openWindow(&#123;</div><div class="line">		<span class="attr">id</span>: <span class="string">'main'</span>,</div><div class="line">		<span class="attr">show</span>: &#123;</div><div class="line">			<span class="attr">aniShow</span>: <span class="string">'pop-in'</span></div><div class="line">		&#125;,</div><div class="line">		<span class="attr">waiting</span>: &#123;</div><div class="line">			<span class="attr">autoShow</span>: <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">	&#125;);</div><div class="line">&#125;, <span class="number">0</span>);</div></pre></td></tr></table></figure></p>
<p>在主页面中通过自定义<code>show</code>事件获得参数：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> username=<span class="literal">null</span>,password=<span class="literal">null</span>;</div><div class="line"><span class="comment">// 页面传参数事件监听</span></div><div class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'show'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">    <span class="comment">// 获得事件参数</span></div><div class="line">    username = event.detail.username;</div><div class="line">    password = event.detail.password;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"username:"</span>+username+<span class="string">"password:"</span>+password);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>我们需要注意的是我们刚刚在登录页面的账号密码传递到了<code>tab-webview-main.html</code>主页面，但是我们的每个子页面没有拿到账号密码。这里就有个容易犯错的地方，我们可能会直接在创建子<code>webview</code>时候通过拓展参数<code>extras</code>传值。</p>
<blockquote>
<ul>
<li>经过试验发现经过预加载的主界面<code>tab-webview-main.html</code>的<code>mui.plusReady</code>方法比页面的自定义事件监听先执行，这是因为我们通过预加载的时候其实已经就执行了<code>mui.plusReady</code>方法，而自定义事件是在<code>webview</code>打开的时候执行。当主界面被预加载时，子页面的<code>loaded</code>事件也随着完成，创建子页面的时候我们根本就没有拿到数据怎么传，自然在子页得到的是<code>undefined</code>。我们这个时候如果想在主界面生成子页面的时候通过拓展参数<code>extras</code>传递给子页面根本行不通！</li>
</ul>
</blockquote>
<ul>
<li><p>当需要接受参数的<code>webview</code>已经完成<code>loaded</code>事件，我们就不能使用拓展参数<code>extras</code>传参数，这个时候我们可以使用<code>webview.evalJS()</code>或者<code>mui.fire()</code>;另外我们使用<code>webview.evalJS()</code>或者<code>mui.fire()</code>时，接收参数的页面的<code>loaded</code>事件也必须发生才能使用。</p>
</li>
<li><p>mui传参数只能相互关联的两个webview之间传，比如A页面打开B页面，B页面打开C页面，A页面可以传值给B页面，但是A页面不能传值给C页面，我们可以通过B页面传给C页面。</p>
</li>
</ul>
<p><strong>验证一个webview的loaded事件是否完成的方法：</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ws = plus.webview.getWebviewById(id)</div><div class="line">ws.addEventListener( <span class="string">"loaded"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log( <span class="string">"Loaded: "</span>+e.target.getURL() );</div><div class="line">&#125;, <span class="literal">false</span> );</div></pre></td></tr></table></figure></p>
<p><strong>验证一个webview的show事件是否完成的方法：</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ws=plus.webview.currentWebview();</div><div class="line">ws.addEventListener(<span class="string">"show"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log( <span class="string">"Webview Showed"</span> );</div><div class="line">&#125;, <span class="literal">false</span> );</div></pre></td></tr></table></figure></p>
<p>说这两个监听事件有啥用处呢，我们在预加载<code>webview</code>的时候，预加载完成的过程，<code>loaded</code>事件也随之完成，但是只有页面被打开时，<code>show</code>事件才完成，我们可以选择合适的时机发送或者接受参数。</p>
<p>这里需要说明的是如果你想<code>localstorage</code>、<code>Storage</code>等本地存储传值，完全可以不用<code>extras</code>或者<code>mui.fire()</code>，当然还可以用<code>url</code>传参数。</p>
<p>因为当初就是为了一个想法，预加载试试，然后试着试着各种问题，不过也因此明白了很多规则和调试方法，在这里提出来顺便总结一下页面传参需要注意的问题，免得新手在此花了很多冤枉时间，搞得现在都快忘了前面写了啥。其实这一部分可以独立出来，但是总感觉这种东西不是啥难事，脱离实际去讲总觉得不合适。</p>
<h3 id="4-获取好友列表及添加好友"><a href="#4-获取好友列表及添加好友" class="headerlink" title="4.获取好友列表及添加好友"></a>4.获取好友列表及添加好友</h3><h4 id="获取好友列表"><a href="#获取好友列表" class="headerlink" title="获取好友列表"></a>获取好友列表</h4><p>我们在登陆页面与环信的服务器建立了联系，但是由于我们执行跳转了，我们依然还需要在需要请求数据时候在当前页面再次建立连接，前面我们讲到可以通过实例化<code>new Easemob.im.Connection()</code>建立连接，我们这里可以在当前页面实例化建立连接，而不是使用登录时的登陆工具类。实例化<code>new Easemob.im.Connection()</code>的三个步骤大家可以查看前面的内容，这里需要说明的是我们获取好友列表是在<code>conn.init</code>方法的<code>onOpened : function(){};</code> 中添加 <code>getRoster</code> 回调方法，从而获取好友列表。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建连接</span></div><div class="line"><span class="keyword">var</span> conn = <span class="keyword">new</span> Easemob.im.Connection();</div><div class="line"><span class="comment">// 初始化连接</span></div><div class="line">conn.init(&#123;</div><div class="line">	<span class="attr">onOpened</span> : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="comment">// mui.toast("成功登录");</span></div><div class="line">		conn.setPresence(); <span class="comment">//设置在线状态</span></div><div class="line">		conn.getRoster(&#123;</div><div class="line">	       <span class="attr">success</span> : <span class="function"><span class="keyword">function</span>(<span class="params">roster</span>) </span>&#123;</div><div class="line">	      		<span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(roster))</div><div class="line">	      		<span class="comment">// 获取当前登录人的好友列表</span></div><div class="line">	      		<span class="keyword">for</span> ( <span class="keyword">var</span> i <span class="keyword">in</span> roster) &#123;</div><div class="line">		  		  <span class="keyword">var</span> ros = roster[i]; <span class="comment">//好友的对象</span></div><div class="line">		          <span class="comment">//ros.name为好友名称</span></div><div class="line">	     		&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;);</div><div class="line">		</div><div class="line">mui.plusReady(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> self = plus.webview.currentWebview().parent();</div><div class="line">	<span class="keyword">var</span> username = self.username;</div><div class="line">	<span class="keyword">var</span> password = self.password;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"username:"</span>+username+<span class="string">"password:"</span>+password);</div><div class="line">    <span class="comment">// 打开连接</span></div><div class="line">	conn.open(&#123;</div><div class="line">	    <span class="attr">user</span> : username,</div><div class="line">	    <span class="attr">pwd</span> : password,</div><div class="line">	    <span class="attr">appKey</span> : Easemob.im.config.appkey</div><div class="line">	&#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>很显然我们在执行后是空的，因为从开始到现在我们都是自己和自己玩，都没有找朋友，那下面我们就去找朋友，之所以先要把这个先写出来，因为这个我觉得是基本逻辑，你待会儿加了好友，怎么看，就通过这里查询，然后才能说后面的聊天。</p>
<h4 id="添加好友"><a href="#添加好友" class="headerlink" title="添加好友"></a>添加好友</h4><p>首先我们得去邀请对方吧，那么我们得知道对方的号码吧，上面我们用的是手机号码作为用户名，为的就是保证用户<code>ID</code>唯一性。</p>
<p><strong>邀请发起方：</strong></p>
<p>我们通过执行<code>conn.subscribe</code>可以发起邀请，添加发起方，获取要添加好友名称，参数为：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	<span class="attr">to</span>: user,  <span class="comment">//对方用户名</span></div><div class="line">	message:<span class="string">"加个好友呗"</span>  <span class="comment">//对方收到的消息</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我们在头部右上角叫一个添加好友按钮：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"addfriend"</span> <span class="attr">class</span>=<span class="string">"mui-btn mui-btn-blue mui-btn-link mui-pull-right"</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>为了简单演示，我们直接弹出一个输入对话框：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 添加好友</span></div><div class="line">mui(<span class="string">"#addfriend"</span>)[<span class="number">0</span>].addEventListener(<span class="string">'tap'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">	e.detail.gesture.preventDefault();</div><div class="line">	<span class="keyword">var</span> btnArray = [<span class="string">'确定'</span>,<span class="string">'取消'</span>];</div><div class="line">	mui.prompt(<span class="string">'请输入你要添加的好友的用户名：'</span>, <span class="string">'手机号'</span>, <span class="string">'邀请好友'</span>, btnArray, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span> (e.index == <span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">var</span> user = e.value;</div><div class="line">			conn.subscribe(&#123;</div><div class="line">				<span class="attr">to</span> : user,</div><div class="line">				<span class="attr">message</span> : <span class="string">"加个好友呗"</span></div><div class="line">			&#125;);</div><div class="line">			mui.toast(<span class="string">'邀请发送成功！'</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			mui.toast(<span class="string">'你取消了发送！'</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;);</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<blockquote>
<p> 需要说明的是如果添加好友是一个单独的页面，或者说所在页面没有和环信建立连接，依然还有进行前面说的三步连接。</p>
</blockquote>
<p><strong>邀请接受方：</strong><br>被添加方，在 con.init 方法中调用 handlePresence 回调方法。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">conn.init(&#123;</div><div class="line">	<span class="comment">//收到联系人订阅请求的回调方法</span></div><div class="line">	onPresence : <span class="function"><span class="keyword">function</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">		handlePresence(message);</div><div class="line">	&#125;</div><div class="line">&#125;);</div><div class="line"> </div><div class="line"><span class="comment">//easemobwebim-sdk中收到联系人订阅请求的处理方法，具体的type值所对应的值请参考xmpp协议规范</span></div><div class="line"><span class="keyword">var</span> handlePresence = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">	mui.toast(<span class="built_in">JSON</span>.stringify(e));</div><div class="line">	<span class="keyword">var</span> user = e.from;</div><div class="line">	<span class="comment">//（发送者希望订阅接收者的出席信息）</span></div><div class="line">	<span class="keyword">if</span> (e.type == <span class="string">'subscribe'</span>) &#123;</div><div class="line">		mui.confirm(<span class="string">'有人要添加你为好友'</span>, <span class="string">'添加好友'</span>, [<span class="string">'确定'</span>,<span class="string">'取消'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">			<span class="keyword">if</span> (e.index == <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">//同意添加好友操作的实现方法</span></div><div class="line">				conn.subscribed(&#123;</div><div class="line">					<span class="attr">to</span> : user,</div><div class="line">				    <span class="attr">message</span> : <span class="string">"[resp:true]"</span></div><div class="line">				&#125;);</div><div class="line">				mui.toast(<span class="string">'你同意添加好友请求'</span>);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">//拒绝添加好友的方法处理</span></div><div class="line">				conn.unsubscribed(&#123;</div><div class="line">					<span class="attr">to</span> : user,</div><div class="line">					<span class="attr">message</span> : <span class="string">"rejectAddFriend"</span></div><div class="line">				&#125;);</div><div class="line">				mui.toast(<span class="string">'你拒绝了添加好友'</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;)</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>前面登陆注册一直很顺利，没啥问题，但是做这个请求好友的时候就出问题了，我们在发送好友请求的时候，然后切换账号登陆的时候接受不到消息。调了好久才发现一些问题：</p>
<ul>
<li>我们发送好友的消息在主界面，所以我初始化了连接，接受消息的在子页面也初始化了连接，居然有时候会有提示<code>onflict</code>，有两种方法：第一，主界面不做任何请求的事，点击添加好友时候，父页面给子页面发消息，然后子页面执行请求添加好友；第二，所有的初始化请求放在主界面，然后收到消息给对应的子页面发消息，为了减少请求，个人采用第二种方法。</li>
<li>当解决上面的冲突问题，为什么登录后收不到消息？这里有个略坑的是环信文档中查询好友时候把<code>onOpened</code>中的这句<code>conn.setPresence();</code>屏蔽了，然后就收不到消息。查文档 <a href="http://docs.easemob.com/im/400webimintegration/80webimfaq" target="_blank" rel="external">常见问题</a> 中说：<br>登录之后需要设置在线状态，才能收到消息。请检查登录成功后是否调用过 conn.setPresence();。<br>加上果然没问题了。。。</li>
</ul>
<p>剩下的功能我们主要看这个文档 <a href="http://docs.easemob.com/im/400webimintegration/25intiate" target="_blank" rel="external">初始化连接</a>，主要是说明了初始化时候的一些回调函数的基本用法，我们这里先来看看<code>onPresence</code>，这个是<strong>收到联系人订阅请求的回调方法</strong>，基本数据类型如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	<span class="string">"from"</span>:<span class="string">"xxxxxxxxxxx"</span>,</div><div class="line">	<span class="string">"to"</span>:<span class="string">"yyyyyyyyyyy"</span>,</div><div class="line">	<span class="string">"fromJid"</span>:<span class="string">"jszblog#musicbox_xxxxxxxxxxx@easemob.com"</span>,</div><div class="line">	<span class="string">"toJid"</span>:<span class="string">"jszblog#musicbox_yyyyyyyyyyy@easemob.com"</span>,</div><div class="line">	<span class="string">"type"</span>:<span class="string">"subscribe"</span>,</div><div class="line">	<span class="string">"chatroom"</span>:<span class="literal">false</span>,</div><div class="line">	<span class="string">"destroy"</span>:<span class="literal">false</span>,</div><div class="line">	<span class="string">"status"</span>:<span class="string">"加个好友呗"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>这里的xxxxxxxxxxx和yyyyyyyyyyy是电话号码，以为我是用电话作为用户名的，出于隐私保护用字母代替。</p>
</blockquote>
<p>当我们切换账号会发现查询好友的地方可以查到好友，下面我们就进行好友列表展示，然后就是和好友聊天咯。</p>
<h3 id="5-数据绑定和本地缓存处理机制"><a href="#5-数据绑定和本地缓存处理机制" class="headerlink" title="5.数据绑定和本地缓存处理机制"></a>5.数据绑定和本地缓存处理机制</h3><p>当我们重新登录的时候打印<code>roster</code>时会得到下面的<code>json</code>对象：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[&#123;</div><div class="line">	<span class="string">"subscription"</span>:<span class="string">"from"</span>,</div><div class="line">	<span class="string">"jid"</span>:<span class="string">"jszblog#musicbox_xxxxxxxxxxx@easemob.com"</span>,</div><div class="line">	<span class="string">"name"</span>:<span class="string">"xxxxxxxxxxx"</span>,</div><div class="line">	<span class="string">"groups"</span>:[]</div><div class="line">&#125;]</div></pre></td></tr></table></figure></p>
<p>为了考虑如果用户没有联网或者数据不能及时更新也能够正常看到历史记录，这里我们考虑做缓存，由于环信<code>web im</code>不具备缓存功能，所以我们这里采用本地存储作为缓存的方案，本地存储可以使用<code>5+</code>中的<code>storage</code>模块，也可以使用<code>localStorage</code>、<code>sessionStorage</code>，由于<code>storage</code>模块中的数据有效域不同，可在应用内跨域操作，数据存储期是持久化的，并且没有容量限制，这里我们采用这个方案，至于如果想把本案例中的例子用于浏览器端的同志，可以采用<code>localStorage</code>作缓存功能。</p>
<p><code>html5+</code>中的<code>storage</code>模块比较简单，文档中介绍了几个基本方法，具体看看文档就可以学会使用，文档见 <a href="http://www.html5plus.org/doc/zh_cn/storage.html" target="_blank" rel="external">【storage】</a>。</p>
<blockquote>
<p>plus.storage.setItem(key, value);</p>
</blockquote>
<p><code>plus.storage.setItem</code>在存储时是以<code>key-value</code>的形式存储，我们可以在查询到好友信息时候，将对象转换成字符串存储在本地，<code>JSON.stringify()</code>将<code>json</code>对象转换成<code>json</code>字符串。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plus.storage.setItem(<span class="string">"roster"</span>,<span class="built_in">JSON</span>.stringify(roster));</div></pre></td></tr></table></figure></p>
<blockquote>
<p>plus.storage.getItem(key);</p>
</blockquote>
<p>我们在子页面通过<code>plus.storage.getItem</code>获取存储的字符串，然后通过<code>JSON.parse()</code>将字符串转化成对象获取相关信息。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> roster = plus.storage.getItem(<span class="string">"roster"</span>);</div><div class="line"><span class="keyword">var</span> obj = <span class="built_in">JSON</span>.parse(roster);</div><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> obj)&#123;</div><div class="line">	<span class="built_in">console</span>.log(obj[i].name);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们现在要做的无非是将信息展示出来，但是这里有用的信息目前只有name，毕竟没有上传文件，所以也不存在头像、昵称、签名这种个性化信息。如何把<code>json</code>信息展示出来前面的文章中我们是使用直接生成<code>dom</code>节点或者拼接<code>html</code>字符串，但是这种过于繁琐，当然也有人使用【js模板引擎】，本来准备早点在文章中给一些新手介绍一下<code>vue.js</code>这种<code>MV-*</code>框架，但是考虑本文中实例的性能，暂且还是用之前用过的一个js模板引擎<a href="https://github.com/aui/artTemplate" target="_blank" rel="external">artTemplate</a>，文档戳这里：<a href="https://github.com/aui/artTemplate。" target="_blank" rel="external">https://github.com/aui/artTemplate。</a><br><code>artTemplate</code>有简洁语法版和原生语法版，就是使用语法不一样而已，这里我使用简洁语法版，戳这里下载——  <a href="https://raw.githubusercontent.com/aui/artTemplate/master/dist/template.js" target="_blank" rel="external">下载地址</a></p>
<p>为了简单，我们采用模板中通讯录的html结构，文档中有这样的一个例子：</p>
<p><strong>编写模板：</strong><br>使用一个type=”text/html”的script标签存放模板：</p>
<pre class="lang-html" ng-non-bindable=""><code class="lang-html">&lt;script id="test" type="text/html"&gt;
    &lt;h1&gt;{{title}}&lt;/h1&gt;
    &lt;ul&gt;
        {{each list as value i}}
            &lt;li&gt;索引 {{i + 1}} ：{{value}}&lt;/li&gt;
        {{/each}}
    &lt;/ul&gt;
&lt;/script&gt;
</code></pre>

<p><strong>渲染模板：</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> data = &#123;</div><div class="line">    <span class="attr">title</span>: <span class="string">'标签'</span>,</div><div class="line">    <span class="attr">list</span>: [<span class="string">'文艺'</span>, <span class="string">'博客'</span>, <span class="string">'摄影'</span>, <span class="string">'电影'</span>, <span class="string">'民谣'</span>, <span class="string">'旅行'</span>, <span class="string">'吉他'</span>]</div><div class="line">&#125;;</div><div class="line"><span class="keyword">var</span> html = template(<span class="string">'test'</span>, data);</div><div class="line"><span class="built_in">document</span>.getElementById(<span class="string">'content'</span>).innerHTML = html;</div></pre></td></tr></table></figure></p>
<p>具体语法参考这里：<a href="https://github.com/aui/artTemplate/wiki/syntax:simple" target="_blank" rel="external">artTemplate 简洁版语法</a></p>
<p>我们可以这样写：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mui-content"</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!--内容--&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"roster-cnt"</span> <span class="attr">class</span>=<span class="string">"mui-table-view mui-table-view-striped mui-table-view-condensed"</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<pre class="lang-html"><code class="lang-html" ng-non-bindable="">&lt;script id="roster-tpl" type="text/template"&gt;
    {{each roster as value index}}
        &lt;li class="mui-table-view-cell" data-chatname="{{value.name}}"&gt;
            &lt;div class="mui-slider-cell"&gt;
                &lt;div class="oa-contact-cell mui-table"&gt;
                    &lt;div class="oa-contact-avatar mui-table-cell"&gt;
                        &lt;img src="http://placehold.it/60x60" /&gt;
                    &lt;/div&gt;
                    &lt;div class="oa-contact-content mui-table-cell"&gt;
                        &lt;div class="mui-clearfix"&gt;
                            &lt;h4 class="oa-contact-name"&gt;小青年&lt;/h4&gt;
                            &lt;span class="oa-contact-position mui-h6"&gt;湖北&lt;/span&gt;
                        &lt;/div&gt;
                        &lt;p class="oa-contact-email mui-h6"&gt;
                            {{value.name}}
                        &lt;/p&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/li&gt;
    {{/each}}
&lt;/script&gt;
</code></pre>

<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mui.plusReady(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> roster = plus.storage.getItem(<span class="string">"roster"</span>);</div><div class="line">	<span class="comment">// console.log(roster);</span></div><div class="line">	<span class="keyword">var</span> data = &#123;</div><div class="line">		<span class="attr">roster</span>: <span class="built_in">JSON</span>.parse(roster)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> html = template(<span class="string">'roster-tpl'</span>, data);</div><div class="line">	<span class="built_in">document</span>.getElementById(<span class="string">'roster-cnt'</span>).innerHTML = html;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>我们其实可以直接先遍历找到<code>name</code>然后填充就<code>ok</code>，这为了后续方便添加昵称、地址、头像等个性化地址，直接使用<code>artTemplate</code>的<code>each</code>方法。</p>
<h3 id="6-聊天消息封装"><a href="#6-聊天消息封装" class="headerlink" title="6.聊天消息封装"></a>6.聊天消息封装</h3><p>当我们完成了前面登陆、注册、添加好友等功能，我们就进行最重要的内容了，既然是聊天功能，当然要聊起来，不然就不叫<code>IM</code>，但是很多人一开始就太过于关注聊天这个功能，而忽略了前面的基础过程，导致对<code>api</code>不熟悉，自然些聊天过程也是漏洞百出，代码逻辑混乱，所以也就放弃了。本文为即时通讯第一篇，没有介绍过多原理，也没有介绍聊天过程的高级功能，仅作为新手入门的基础篇介绍，后面会再深入探究更多内容。废话不多说，我们继续看文档写下面的内容。</p>
<p>我们先新建一个<code>single-chat.html</code>，本文不打算基于<code>html mui</code>中的页面去构建聊天页面，打算从零开始写。</p>
<p>首先我们需要在刚刚那个通讯录页面里面点击进入聊天页面，将用户名的值传到聊天页面，我们可以直接在创建的时候用拓展参数传，或者预加载打开时用<code>mui.fire()</code>,不多说，自己参考第三小节。</p>
<p>我们先说说布局的问题，先上图</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://oo1uw74rb.bkt.clouddn.com/20160615002.png" alt="clipboard.png" title="">
                </div>
                <div class="image-caption">clipboard.png</div>
            </figure>
<p>对应的布局详细代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></div><div class="line">.chat-history-date&#123; </div><div class="line">	display: block;</div><div class="line">	padding-top: 5px;</div><div class="line">	text-align: center;</div><div class="line">	font-size: 12px;</div><div class="line">&#125;</div><div class="line">.chat-receiver,.chat-sender&#123;</div><div class="line">	margin: 5px;</div><div class="line">    clear:both;  </div><div class="line">&#125;</div><div class="line">.chat-avatar img&#123;</div><div class="line">    width: 40px;</div><div class="line">    height: 40px;</div><div class="line">    border-radius: 50%;</div><div class="line">&#125;</div><div class="line">.chat-receiver .chat-avatar&#123;</div><div class="line">	float: left;</div><div class="line">&#125;</div><div class="line">.chat-sender .chat-avatar&#123;</div><div class="line">	float: right;</div><div class="line">&#125;</div><div class="line">.chat-content&#123;</div><div class="line">	position: relative;</div><div class="line">	max-width: 60%;</div><div class="line">    min-height: 20px;</div><div class="line">	margin: 0 10px 10px 10px;</div><div class="line">    padding: 10px;</div><div class="line">    font-size:15px;</div><div class="line">    border-radius:7px; </div><div class="line">&#125;</div><div class="line">.chat-content img&#123;</div><div class="line">	width: 100%;</div><div class="line">&#125;</div><div class="line">.chat-receiver .chat-content&#123;</div><div class="line">	float: left; </div><div class="line">	color: #383838; </div><div class="line">    background-color: #f5f5f5;</div><div class="line">&#125;</div><div class="line">.chat-sender .chat-content&#123;</div><div class="line">    float:right;   </div><div class="line">    color: #ffffff; </div><div class="line">    background-color: #15b5e9; </div><div class="line">&#125;</div><div class="line">.chat-triangle&#123;</div><div class="line">	position: absolute;</div><div class="line">	top:6px;</div><div class="line">	width:0px; </div><div class="line">	height:0px; 	   </div><div class="line">    border-width:8px; </div><div class="line">    border-style:solid;   </div><div class="line">&#125;</div><div class="line">.chat-receiver .chat-triangle&#123; </div><div class="line">	left:-16px;</div><div class="line">    border-color:transparent #f5f5f5 transparent transparent;      </div><div class="line">&#125;</div><div class="line">.chat-sender .chat-triangle&#123; </div><div class="line">	right:-16px;</div><div class="line">    border-color:transparent transparent transparent #15b5e9;      </div><div class="line">&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!--消息最后历史时间--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"chat-history-date"</span>&gt;</span>01:59<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="comment">&lt;!--接收文本消息--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-receiver"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-avatar"</span>&gt;</span></div><div class="line">  		<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"../img/chat-1.png"</span>&gt;</span></div><div class="line">  	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-content"</span>&gt;</span></div><div class="line">  		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-triangle"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  		<span class="tag">&lt;<span class="name">span</span>&gt;</span>如果是接受消息，请使用.chat-receiver类，如果是发送消息，请使用.chat-sender，头像是.chat-avatar类，内容是.chat-content类。.chat-content下如果是span标签则为文本消息，若为img标签则为图片消息。<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="comment">&lt;!--发送文本消息--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-sender"</span>&gt;</span></div><div class="line">  	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-avatar"</span>&gt;</span></div><div class="line">  		<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"../img/chat-2.png"</span>&gt;</span></div><div class="line">  	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-content"</span>&gt;</span></div><div class="line">  		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-triangle"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  		<span class="tag">&lt;<span class="name">span</span>&gt;</span>如果你要修改聊天气泡的背景颜色，请修改.chat-content的background-color和.chat-triangle的border-color<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="comment">&lt;!--发送图片消息--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-sender"</span>&gt;</span></div><div class="line">  	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-avatar"</span>&gt;</span></div><div class="line">  		<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"../img/chat-2.png"</span>&gt;</span></div><div class="line">  	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-content"</span>&gt;</span></div><div class="line">  		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-triangle"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  		<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"../img/test.jpg"</span>/&gt;</span></div><div class="line">  	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>我们的消息分为发送和收到两种情况，上面是静态效果，我们下面需要做的事获取数据然后动态展示，现在我们先封装一下页面展示效果的代码。这里我们使用两种方法，一种是直接用<code>js</code>生成<code>dom</code>节点，这种使用于结构固定后面不需要改动的，直接用一个<code>js function</code>封装，每次调用一行代码就可以直接显示内容，这样想想都觉得很棒。</p>
<p>老司机，别说话，快看代码！<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * @description 显示消息</div><div class="line"> * @param &#123;String&#125; who 消息来源,可选参数: &#123;params&#125; 'sender','receiver'</div><div class="line"> * @param &#123;Object&#125; type 消息类型,可选参数: &#123;params&#125; 'text','url','img'</div><div class="line"> * @param &#123;JSON&#125; data 消息数据,可选参数: &#123;params&#125; </div><div class="line"> * ('text'和'url'类型的msg是文字，img类型的msg是img地址)</div><div class="line"> */</div><div class="line"><span class="keyword">var</span> appendMsg = <span class="function"><span class="keyword">function</span>(<span class="params">who,type,data</span>) </span>&#123;</div><div class="line">	<span class="comment">// 生成节点</span></div><div class="line">	<span class="keyword">var</span> domCreat = <span class="function"><span class="keyword">function</span>(<span class="params">node</span>)</span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="built_in">document</span>.createElement(node)</div><div class="line">	&#125;;</div><div class="line">	</div><div class="line">	<span class="comment">// 基本节点</span></div><div class="line">	<span class="keyword">var</span> msgItem = domCreat(<span class="string">"div"</span>),</div><div class="line">		avatarBox = domCreat(<span class="string">"div"</span>),</div><div class="line">		contentBox = domCreat(<span class="string">"div"</span>),</div><div class="line">		avatar = domCreat(<span class="string">"img"</span>),</div><div class="line">		triangle = domCreat(<span class="string">"div"</span>);</div><div class="line">	</div><div class="line">	<span class="comment">// 头像节点</span></div><div class="line">	avatarBox.className=<span class="string">"chat-avatar"</span>;</div><div class="line">	avatar.src = (who==<span class="string">"sender"</span>)?data.senderAvatar:data.receiverAvatar;</div><div class="line">	avatarBox.appendChild(avatar);</div><div class="line">	</div><div class="line">	<span class="comment">// 内容节点</span></div><div class="line">	contentBox.className=<span class="string">"chat-content"</span>;</div><div class="line">	triangle.className=<span class="string">"chat-triangle"</span>;</div><div class="line">	contentBox.appendChild(triangle);</div><div class="line">	</div><div class="line">	<span class="comment">// 消息类型</span></div><div class="line">	<span class="keyword">switch</span> (type)&#123;</div><div class="line">		<span class="keyword">case</span> <span class="string">"text"</span>:</div><div class="line">	        <span class="keyword">var</span> msgTextNode = domCreat(<span class="string">"span"</span>);</div><div class="line">			<span class="keyword">var</span> textnode=<span class="built_in">document</span>.createTextNode(data.msg);</div><div class="line">			msgTextNode.appendChild(textnode);</div><div class="line">			contentBox.appendChild(msgTextNode);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">"url"</span>:</div><div class="line">			<span class="keyword">var</span> msgUrlNode = domCreat(<span class="string">"a"</span>);</div><div class="line">			<span class="keyword">var</span> textnode=<span class="built_in">document</span>.createTextNode(data.msg);</div><div class="line">			<span class="keyword">if</span>(data.indexOf(<span class="string">'http://'</span>) &lt; <span class="number">0</span>)&#123;</div><div class="line">				data.msg = <span class="string">"http://"</span> + data.msg;</div><div class="line">			&#125;</div><div class="line">			msgUrlNode.setAttribute(<span class="string">"href"</span>,data.msg); </div><div class="line">			msgUrlNode.appendChild(textnode);</div><div class="line">			contentBox.appendChild(msgUrlNode);			</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">"img"</span>:</div><div class="line">			<span class="keyword">var</span> msgImgNode = domCreat(<span class="string">"img"</span>);</div><div class="line">			msgImgNode.src = data.msg;</div><div class="line">			contentBox.appendChild(msgImgNode);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">// 节点连接</span></div><div class="line">	msgItem.className=<span class="string">"chat-"</span>+who;</div><div class="line">	msgItem.appendChild(avatarBox);</div><div class="line">	msgItem.appendChild(contentBox);</div><div class="line">	<span class="built_in">document</span>.querySelector(data.el).appendChild(msgItem);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其实后面我们拓展也很容易的，只需要不断加<code>type</code>类型就<code>ok</code>，这些都是<code>dom</code>操作的基本方法，如果对一些方法不熟悉，建议看看相关的内容。这里遵照<code>JSDoc+</code>规范还加上了使用参数提示，在<code>hbuilder</code>使用可以查看参数含义，再也不用担心写代码时忘记了参数含义。</p>
<p>这里我们也可以用模板引擎的办法去封装，代码如下：</p>
<p><strong>模板内容：</strong></p>
<pre class="lang-html" ng-non-bindable=""><code class="lang-html">&lt;script id="msg-tpl" type="text/html"&gt;
    &lt;div class="chat-{{who}}"&gt;
        &lt;div class="chat-avatar"&gt;
            &lt;img src="{{avatar}}"&gt;
        &lt;/div&gt;
        &lt;div class="chat-content"&gt;
            &lt;div class="chat-triangle"&gt;&lt;/div&gt;
            {{if type=="text"}}
                &lt;span&gt;{{msg}}&lt;/span&gt;
            {{else if type=="url"}}
                &lt;a href="{{msg}}"&gt;{{msg}}&lt;/a&gt;
            {{else if type=="img"}}
                &lt;img src="{{msg}}"/&gt;
            {{/if}}
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/script&gt;
</code></pre>

<p><strong>模板渲染：</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * @description 显示消息</div><div class="line"> * @param &#123;String&#125; who 消息来源,可选参数: &#123;params&#125; 'sender','receiver'</div><div class="line"> * @param &#123;Object&#125; type 消息类型,可选参数: &#123;params&#125; 'text','url','img'</div><div class="line"> * @param &#123;JSON&#125; data 消息数据,可选参数: &#123;params&#125; </div><div class="line"> * ('text'和'url'类型的msg是文字，img类型的msg是img地址)</div><div class="line"> */</div><div class="line"><span class="keyword">var</span> appendMsg = <span class="function"><span class="keyword">function</span>(<span class="params">who,type,data</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> html = template(<span class="string">'msg-tpl'</span>, &#123;</div><div class="line">		<span class="attr">who</span>: who,</div><div class="line">		<span class="attr">type</span>: type,</div><div class="line">		<span class="attr">avatar</span>: who==<span class="string">'sender'</span>?data.senderAvatar:data.receiverAvatar,</div><div class="line">		<span class="attr">msg</span>: data.msg</div><div class="line">	&#125;);</div><div class="line">	<span class="built_in">document</span>.querySelector(data.el).innerHTML += html;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>大家使用也很简单，调用方法如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">appendMsg(<span class="string">'sender'</span>,<span class="string">'text'</span>,&#123;</div><div class="line">    <span class="attr">el</span>: <span class="string">'#msg-list'</span>, <span class="comment">//消息容器</span></div><div class="line">	senderAvatar: <span class="string">'../img/chat-1.png'</span>,  <span class="comment">//发送者头像</span></div><div class="line">	receiverAvatar: <span class="string">'../img/chat-2.png'</span>, <span class="comment">//接收者头像</span></div><div class="line">	msg: <span class="string">'你好'</span> <span class="comment">//消息内容</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>如果大家觉得每次调用还要填写容器id，头像地址这种基本固定的内容很麻烦，大家也可以继续封装：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 消息初始化</div><div class="line"> */</div><div class="line"><span class="keyword">var</span> msgInit = &#123;</div><div class="line">	<span class="attr">el</span>: <span class="string">'#msg-list'</span>, <span class="comment">//消息容器</span></div><div class="line">	senderAvatar: <span class="string">'../img/chat-1.png'</span>,  <span class="comment">//发送者头像</span></div><div class="line">	receiverAvatar: <span class="string">'../img/chat-2.png'</span> <span class="comment">//接收者头像</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * @description 展示消息精简版</div><div class="line"> * @param &#123;String&#125; who 消息来源,可选参数: &#123;params&#125; 'sender','receiver'</div><div class="line"> * @param &#123;Object&#125; type 消息类型,可选参数: &#123;params&#125; 'text','url','img'</div><div class="line"> * @param &#123;Object&#125; msg ('text'和'url'类型的msg是文字，img类型的msg是img地址)</div><div class="line"> */</div><div class="line"><span class="keyword">var</span> msgShow = <span class="function"><span class="keyword">function</span>(<span class="params">who,type,msg</span>)</span>&#123;</div><div class="line">	appendMsg(who,type,&#123;</div><div class="line">		<span class="attr">el</span>: msgInit.el,</div><div class="line">		<span class="attr">senderAvatar</span>: msgInit.senderAvatar,</div><div class="line">		<span class="attr">receiverAvatar</span>: msgInit.receiverAvatar,</div><div class="line">		<span class="attr">msg</span>: msg</div><div class="line">	&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用方法很简单：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msgShow(<span class="string">'sender'</span>,<span class="string">'text'</span>,<span class="string">'你好'</span>);</div></pre></td></tr></table></figure></p>
<p>两种方法实现封装的函数一样，这里只是给大家演示一下对于这种动态结构的<code>html</code>的一些方法，当然只要你愿意，你可以直接用字符串拼接，或者用<code>&lt;template&gt;&lt;/template&gt;</code>标签自己做一个这样的模板引擎，或者使用使用更加方便的<code>mvc</code>或<code>mvvm</code>框架。</p>
<p>之所以要花大篇幅内容将这些基础内容，是因为看到很多人代码写得那叫一个混乱，如果接口啥的一改，我相信这些人会疯掉，因为代码缺乏一定的通用性，没有把变与不变的内容分别拿出来。当然我们上面其实有些东西没有封装进去，比如用户名或者昵称，这在群聊中是有必要的，这里只是以最简单的例子来说明，大家可以根据自己的业务需求自由发挥。</p>
<h3 id="7-单聊之文本消息"><a href="#7-单聊之文本消息" class="headerlink" title="7.单聊之文本消息"></a>7.单聊之文本消息</h3><h4 id="基本思路"><a href="#基本思路" class="headerlink" title="基本思路"></a>基本思路</h4><p>其实写到这里本篇基本也算告一段落，但是考虑到很多新手对于收发消息很多还是有一些问题，我们这里就还是把文本消息发送接收写完了再收篇。</p>
<p>上面我们我们讲了怎么把消息展示出来，但是毕竟聊起来数据是动态的，那么发送接收数据是很重要的一步，先来写发送消息。我们先定义一个底部的输入框加按钮，代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></div><div class="line">footer &#123;</div><div class="line">	position: fixed;</div><div class="line">	width: 100%;</div><div class="line">	height: 50px;</div><div class="line">	min-height: 50px;</div><div class="line">	border-top: solid 1px #bbb;</div><div class="line">	left: 0px;</div><div class="line">	bottom: 0px;</div><div class="line">	overflow: hidden;</div><div class="line">	padding: 0px 50px;</div><div class="line">	background-color: #fafafa;</div><div class="line">&#125;</div><div class="line">.footer-left &#123;</div><div class="line">	position: absolute;</div><div class="line">	width: 50px;</div><div class="line">	height: 50px;</div><div class="line">	left: 0px;</div><div class="line">	bottom: 0px;</div><div class="line">	text-align: center;</div><div class="line">	vertical-align: middle;</div><div class="line">	line-height: 100%;</div><div class="line">	padding: 12px 4px;</div><div class="line">&#125;</div><div class="line">.footer-right &#123;</div><div class="line">	position: absolute;</div><div class="line">	width: 50px;</div><div class="line">	height: 50px;</div><div class="line">	right: 0px;</div><div class="line">	bottom: 0px;</div><div class="line">	text-align: center;</div><div class="line">	vertical-align: middle;</div><div class="line">	line-height: 100%;</div><div class="line">	padding: 12px 5px;</div><div class="line">	display: inline-block;</div><div class="line">&#125;</div><div class="line">.footer-center &#123;</div><div class="line">	height: 100%;</div><div class="line">	padding: 5px 0px;</div><div class="line">&#125;</div><div class="line">.footer-center [class*=input] &#123;</div><div class="line">	width: 100%;</div><div class="line">	height: 100%;</div><div class="line">	border-radius: 5px;</div><div class="line">&#125;</div><div class="line">.footer-center .input-text &#123;</div><div class="line">	background: #fff;</div><div class="line">	border: solid 1px #ddd;</div><div class="line">	padding: 10px !important;</div><div class="line">	font-size: 16px !important;</div><div class="line">	line-height: 18px !important;</div><div class="line">	font-family: verdana !important;</div><div class="line">	overflow: hidden;</div><div class="line">&#125;</div><div class="line"></div><div class="line">footer .mui-icon &#123;</div><div class="line">		color: #000;</div><div class="line">&#125;</div><div class="line">footer .mui-icon:active &#123;</div><div class="line">	color: #007AFF !important;</div><div class="line">&#125;</div><div class="line">.footer-right span&#123;</div><div class="line">	color: #0062CC;</div><div class="line">	line-height: 30px;</div><div class="line">&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mui-content"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"msg-list"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">footer</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"footer-left"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">i</span> <span class="attr">id</span>=<span class="string">'msg-choose-img'</span> <span class="attr">class</span>=<span class="string">"mui-icon mui-icon-camera"</span> <span class="attr">style</span>=<span class="string">"font-size: 28px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"footer-center"</span>&gt;</span></div><div class="line">	    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">'msg-text'</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">'input-text'</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"footer-right"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">'msg-send-text'</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>为了代码整洁规范，方便后期封装，参考<code>hello mui</code>中<code>im-chat.html</code>的写法，我们先定义一下<code>ui</code>控件对象：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// UI控件对象</span></div><div class="line"><span class="keyword">var</span> ui = &#123;</div><div class="line">    <span class="attr">content</span>: mui(<span class="string">'.mui-content'</span>[<span class="number">0</span>]),</div><div class="line">    <span class="attr">msgList</span>: mui(<span class="string">'#msg-list'</span>)[<span class="number">0</span>],</div><div class="line">    <span class="attr">footer</span>: mui(<span class="string">'footer'</span>)[<span class="number">0</span>],</div><div class="line">    <span class="attr">msgChooseImg</span>: mui(<span class="string">"#msg-choose-img"</span>)[<span class="number">0</span>],</div><div class="line">    <span class="attr">msgText</span>: mui(<span class="string">'#msg-text'</span>)[<span class="number">0</span>],</div><div class="line">    <span class="attr">msgSendText</span>: mui(<span class="string">'#msg-send-text'</span>)[<span class="number">0</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>发送文本消息很简单：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 发送文本消息</span></div><div class="line">ui.msgSendText.addEventListener(<span class="string">'tap'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	sendText();</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// 发送文本</span></div><div class="line"><span class="keyword">var</span> sendText = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> msg = ui.msgText.value.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'\n'</span>, <span class="string">'gm'</span>), <span class="string">'&lt;br/&gt;'</span>);</div><div class="line">    <span class="keyword">var</span> validateReg = <span class="regexp">/^\S+$/</span>;</div><div class="line">    <span class="comment">// 获得键盘焦点</span></div><div class="line">    msgTextFocus();</div><div class="line">    <span class="keyword">if</span>(validateReg.test(msg))&#123;</div><div class="line">        <span class="comment">// 消息展示出来</span></div><div class="line">    	msgShow(<span class="string">'sender'</span>,<span class="string">'text'</span>,msg);</div><div class="line">    	<span class="comment">// 发送文本消息到环信服务器</span></div><div class="line">		conn.sendTextMessage(&#123;</div><div class="line">			<span class="attr">to</span>: chatName, <span class="comment">//用户登录名，SDK根据AppKey和domain组织jid，如easemob-demo#chatdemoui_**TEST**@easemob.com，中"to:TEST",下同</span></div><div class="line">			msg: msg, <span class="comment">//文本消息</span></div><div class="line">			type: <span class="string">"chat"</span></div><div class="line">			<span class="comment">//ext :&#123;"extmsg":"extends messages"&#125;//用户自扩展的消息内容（群聊用法相同）</span></div><div class="line">		&#125;);	</div><div class="line">		<span class="comment">// 清空文本框</span></div><div class="line">		ui.msgText.value = <span class="string">''</span>;</div><div class="line">		<span class="comment">// 恢复输入框高度(因为我们这里是50px，你可以写一个全局变量)</span></div><div class="line">		ui.footer.style.height = <span class="string">'50px'</span>;</div><div class="line">		<span class="comment">// 保持输入状态</span></div><div class="line">		mui.trigger(ui.msgText, <span class="string">'input'</span>, <span class="literal">null</span>);</div><div class="line">		<span class="comment">// 这一句让内容滚动起来</span></div><div class="line">		msgScrollTop();</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">    	mui.toast(<span class="string">"文本消息不能为空"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里的<code>msgTextFocus();</code>和<code>msgScrollTop();</code>是封装的两个方法，具体的且看下文。</p>
<p>再来说说收消息，我们需要在<code>conn.init()</code>配置设置收到消息的回调函数<code>onTextMessage</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 初始化连接</span></div><div class="line">conn.init(&#123;</div><div class="line">    <span class="attr">onOpened</span> : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	    <span class="comment">//mui.toast("成功登录");</span></div><div class="line">		conn.setPresence();</div><div class="line">	&#125;,</div><div class="line">	<span class="comment">// 收到文本消息时的回调函数</span></div><div class="line">	onTextMessage : <span class="function"><span class="keyword">function</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">		<span class="comment">// console.log(JSON.stringify(message));</span></div><div class="line">		<span class="keyword">var</span> <span class="keyword">from</span> = message.from;<span class="comment">//消息的发送者</span></div><div class="line">		<span class="keyword">var</span> msg = message.data;<span class="comment">//文本消息体	</span></div><div class="line">		<span class="comment">//mui.toast(msg);</span></div><div class="line">		<span class="comment">// 收到文本消息在页面展示</span></div><div class="line">		msgShow(<span class="string">'receiver'</span>,<span class="string">'text'</span>,msg);</div><div class="line">		msgScrollTop();</div><div class="line">	&#125;,</div><div class="line">	<span class="comment">// 收到图片消息时的回调函数</span></div><div class="line">	onPictureMessage : <span class="function"><span class="keyword">function</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">		handlePictureMessage(message);</div><div class="line">	&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>至此我们完成了基本的文本消息收发功能，但是有几个细节是需要处理的，比如我们上面说的两个函数啥意思，我们没有解释。</p>
<h4 id="获得输入框焦点事件和强制弹出软键盘"><a href="#获得输入框焦点事件和强制弹出软键盘" class="headerlink" title="获得输入框焦点事件和强制弹出软键盘"></a>获得输入框焦点事件和强制弹出软键盘</h4><p>我们如果不做处理，在输入框失去焦点时软键盘会自动收回软键盘，这样很影响聊天时候的用户体验。这个时候我们可以在输入完内容，准备发送时，保持输入状态<code>mui.trigger(ui.msgText, &#39;input&#39;, null);</code>。</p>
<p>让输入框获得焦点的方法：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获得输入框键盘焦点</span></div><div class="line"><span class="keyword">var</span> msgTextFocus = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    ui.msgText.focus();</div><div class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        ui.msgText.focus();</div><div class="line">	&#125;, <span class="number">150</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>强制弹出软键盘的方法：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 强制弹出软键盘</span></div><div class="line"><span class="keyword">var</span> showKeyboard = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mui.os.ios) &#123;</div><div class="line">        <span class="keyword">var</span> webView = plus.webview.currentWebview().nativeInstanceObject();</div><div class="line">		webView.plusCallMethod(&#123;</div><div class="line">			<span class="string">"setKeyboardDisplayRequiresUserAction"</span>: <span class="literal">false</span></div><div class="line">		&#125;);</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(mui.os.android) &#123;</div><div class="line">		<span class="keyword">var</span> Context = plus.android.importClass(<span class="string">"android.content.Context"</span>);</div><div class="line">		<span class="keyword">var</span> InputMethodManager = plus.android.importClass(<span class="string">"android.view.inputmethod.InputMethodManager"</span>);</div><div class="line">		<span class="keyword">var</span> main = plus.android.runtimeMainActivity();</div><div class="line">		<span class="keyword">var</span> imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);</div><div class="line">		imm.toggleSoftInput(<span class="number">0</span>,InputMethodManager.SHOW_FORCED);</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h4 id="聊天消息高度调整"><a href="#聊天消息高度调整" class="headerlink" title="聊天消息高度调整"></a>聊天消息高度调整</h4><p>聊天消息如何发送或者收到一条自己往上滚动呢？我们看qq消息就是最后一条消息就会自动出现在输入框之上，调整方法是使用<code>scrollTop</code>方法，通过计算<code>scrollHeight</code>和`offsetHeight的高度，实现调整。对这些高度不理解？看这里：</p>
<ul>
<li><p><a href="http://www.cnblogs.com/polk6/p/5051935.html" target="_blank" rel="external">HTML 获取屏幕、浏览器、页面的高度宽度</a></p>
</li>
<li><p><a href="http://ask.dcloud.net.cn/article/205" target="_blank" rel="external">深入理解高度。获取屏幕、webview、软键盘高度</a></p>
</li>
</ul>
<p>其实这个地方有很多技术细节，比如消息高度虽然可以获取，但是要实现局部滚动，那么必须禁止浏览器默认的滚动模式，具体可以看看这篇文章的实现原理<a href="https://isux.tencent.com/inner-scroll-layout.html" target="_blank" rel="external">浅议内滚动布局</a></p>
<p>具体css样式设置方法：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">html,</div><div class="line">body &#123;</div><div class="line">	height: 100%;</div><div class="line">	margin: 0px;</div><div class="line">	padding: 0px;</div><div class="line">	overflow: hidden;</div><div class="line">	-webkit-touch-callout: none;</div><div class="line">	-webkit-user-select: none;</div><div class="line">&#125;</div><div class="line">.mui-content&#123;</div><div class="line">	height: 100%;</div><div class="line">	padding: 44px 0px 50px 0px;</div><div class="line">	overflow: auto;</div><div class="line">	background-color: #eaeaea;</div><div class="line">&#125;</div><div class="line">#msg-list &#123;</div><div class="line">	height: 100%;</div><div class="line">	overflow: auto;</div><div class="line">	-webkit-overflow-scrolling: touch;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用的函数封装如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 消息滚动</span></div><div class="line"><span class="keyword">var</span> msgScrollTop = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	ui.msgList.scrollTop = ui.msgList.scrollHeight + ui.msgList.offsetHeight;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="输入框高度如何自适应"><a href="#输入框高度如何自适应" class="headerlink" title="输入框高度如何自适应"></a>输入框高度如何自适应</h4><p>不多说直接上代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 输入框监听事件</span></div><div class="line">ui.msgText.addEventListener(<span class="string">'input'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">    msgTextFocus();</div><div class="line">	ui.footer.style.height = <span class="keyword">this</span>.scrollHeight + <span class="string">'px'</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="解决长按导致致键盘关闭的问题"><a href="#解决长按导致致键盘关闭的问题" class="headerlink" title="解决长按导致致键盘关闭的问题"></a>解决长按导致致键盘关闭的问题</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 解决长按“发送”按钮，导致键盘关闭的问题；</span></div><div class="line">ui.msgSendText.addEventListener(<span class="string">'touchstart'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">    msgTextFocus();</div><div class="line">	event.preventDefault();</div><div class="line">&#125;);</div><div class="line">ui.msgSendText.addEventListener(<span class="string">'touchmove'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">	msgTextFocus();</div><div class="line">	event.preventDefault();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>当做到这里我们基本要讲解的够新手去理解了，但是对于项目功能实现来说，远远不够，毕竟只是文字发送接收，那么图片、语音、地址等等高级功能呢，我们这篇文章限于篇幅不可能一一道来，只能后面再做补充。这里希望更多人参与到其中进行贡献。这里可以放出地址了，详情代码请关注这里：<a href="https://github.com/zhaomenghuan/mui-demo/tree/master/easemobIM" target="_blank" rel="external">https://github.com/zhaomenghuan/mui-demo/tree/master/easemobIM</a>。后期功能拓展和bug修复都贵提交到这里，欢迎大家贡献。</p>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><p>由于这段时间确实有点忙，这篇文章也花了很多时间去码字，去修改，改了很多次，才有这篇文章，希望能够给新手一些启示和帮助吧！本文不是着重讲环信sdk怎么用，而是讲解这个过程中可能会遇到的一些问题和实现思路，所以不建议新手直接拿最后的代码改之类的，还是看懂了思路再说，所以至于这个IM更多的功能后期会不会继续开发，暂时是未知数，所以大家不要等待，欢迎大神多多贡献分享相关代码，这样方便更多人学习使用。</p>
<p>这里想和大家简单说下，不要所有的问题直接私聊我，我时间精力有限，个人觉得不回复不好，所以我不会看到消息装着没看到，但是也不可能一一去回复，毕竟时间精力上也有限，我也需要不断学习，所以不希望过多的被打扰。大家有问题建议去论坛先搜搜答案，看看官方文档自己解决，大家确实有解决不了的问题，可以在群里寻求帮助或者给我发消息。提问前建议把问题描述清楚，想要实现什么，然后现在的实现思路，最好附上代码说明或者发测试文件，这样也方便解决问题。很多人说直接是直接是根据官方demo改的，说啥bug，很多时候聊到最后发现是他自己的原因，这种情况真的很浪费彼此时间。在此声明以后一上来直接要帮忙写代码的，或者让我发一遍文档地址的等等这种可以自己可以解决的问题，请原谅我直接果断拒绝，我理解新手理解小白初入门的盲目，但是建议不要去依赖，要自己去尝试，不懂再问，不要还没有去了解去查资料，直接一上来求带这种要求。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://segmentfault.com/img/bVycIN" alt="clipboard.png" title="">
                </div>
                <div class="image-caption">clipboard.png</div>
            </figure>
<hr>
<p>如果有项目需求，欢迎私聊。承接各种前端项目，同时如果有功能定制，代码优化等需求也可以商量，算发个小广告吧，毕竟我也要生活，要挣钱娶媳妇养家糊口。</p>
<p>写文章不容易，也许写这些代码就几十分钟的事，写一篇大家好接受的文章或许需要几天的酝酿，然后加上几天的码字，累并快乐着。如果文章对您有帮助请我喝杯咖啡吧！进行赞助的同学私信留下你们的联系方式，后期发文章会单独邮件通知，有开发的问题也可以私聊，有相关功能需求，可以考虑优先写文分享。在此特别感谢之前给予赞助的同学，名单有保存，后期在博客会有公示。</p>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2017-05-03T16:15:32.882Z" itemprop="dateUpdated">2017-05-04 00:15:32</time>
</span><br>


        
        转载需标注本文原始地址：<a href="/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/" target="_blank" rel="external">https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/</a>
        
    </div>
    <footer>
        <a href="https://zhaomenghuan.github.io">
            <img src="/img/avatar.png" alt="赵梦欢">
            赵梦欢
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/html5plus/">html5plus</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/im/">im</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mui/">mui</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/环信/">环信</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/缓存/">缓存</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/页面传值/">页面传值</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/&title=《mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK》 — 小青年博客&pic=https://zhaomenghuan.github.io/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/&title=《mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK》 — 小青年博客&source=小青年,小青年博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK》 — 小青年博客&url=https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/&via=https://zhaomenghuan.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2016/07/03/JavaScript进阶学习（二）—基于原型链继承的js工具库的实现方法/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">JavaScript进阶学习（二）—— 基于原型链继承的js工具库的实现方法</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2016/06/05/mui初级入门教程（四）—再谈webview，从小白变“大神”！/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">mui初级入门教程（四）—  再谈webview，从小白变“大神”！</h4>
      </a>
    </div>
  
</nav>



    













</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        感谢老铁~
        <i class="icon icon-quote-right"></i>
    </h3>
    <ul class="reward-items">
        
        <li>
            <img src="/img/wechat.png" title="微信打赏二维码" alt="微信打赏二维码">
            <p>微信</p>
        </li>
        

        
        <li>
            <img src="/img/alipay.png" title="支付宝打赏二维码" alt="支付宝打赏二维码">
            <p>支付宝</p>
        </li>
        
    </ul>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p>
            <span>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></span>
            <span>赵梦欢 &copy; 2015 - 2017</span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/&title=《mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK》 — 小青年博客&pic=https://zhaomenghuan.github.io/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/&title=《mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK》 — 小青年博客&source=小青年,小青年博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《mui初级入门教程（五）—  聊聊即时通讯（IM），基于环信 web im SDK》 — 小青年博客&url=https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/&via=https://zhaomenghuan.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://zhaomenghuan.github.io/2016/06/15/mui初级入门教程（五）—聊聊即时通讯（IM），基于环信 web im SDK/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASYAAAEmCAAAAADqr2IGAAAEmElEQVR42u3aS27bQBAFQN//0gqQlYPE1nvdFKKhiytDlobD4qJ/8/ERX4/f1+e/P3+SfP79d/7+5leftJ//fcevfnvBhQkTJkyY3pLp8e2VL71Z56vvfM+avKT8lX+1Z0yYMGHCdA+mq7aeJwRJAtHSJC+mfW2YMGHChOnnMOWbaFOBnDJZJ3/BmDBhwoQJU9vkna25KWvz/2LChAkTpp/MlCzXficfal7123b9l/TCMWHChAnTmzHNDu7c4++Xn2/ChAkTJkz/lemxuGat23wnbcBu91w8KSZMmDBhOpYpaZLO4mYShtsmb56stKzRfjBhwoQJ07FMbZicNW03g8x2+JqvkDeXMWHChAnTiUxJATnbbjueTPawSQ5mY9GPdouYMGHChOnNmPJttWVt29htE4ucvi19oyYvJkyYMGE6hClv786K4X3qMEsjNq//H6thwoQJE6bDmTYjyVnR2x67aYvbvACOkh5MmDBhwnQ4U1K4Jt8sGqZxYJ41fzdJQH2yCRMmTJgwvTHTLMwnW2mTjHb99i75q3pysgkTJkyYMB3IVATF+PtXzVo3h35mreQik8KECRMmTG/PNFu0Dbo5wWyMmh/caYteTJgwYcJ0D6Y89LYPlqzcjhhnhfGsuYwJEyZMmO7ElBe3ebH6iK89Tdt6zhvQmDBhwoTpHkyzgy+bJmx7ZCcP/G2x/eT7mDBhwoTpWKZNcbgZED4JwDF3PkbNR571WBcTJkyYML0902zE2AbsFrQtpF/9CjFhwoQJ04lMm5u1W3ldezcaSW4KXUyYMGHCdDhTHozbdm07yJw92OwFJ63taOqLCRMmTJiOYkqCdN5+bbebDynblm6bEPzxX0yYMGHCdFOmWSu2HUzOCuZZ0Ttr9WLChAkTpnswta3VWXLQHrvJ28F507kuszFhwoQJ0+FMsxJ3n1LkLdrZPnOyJ0+BCRMmTJgOZ5o9TBvO26M5edKQ7HP232jqiwkTJkyYDmHalMEJTRJb8xHj7BDPMNHBhAkTJkzHMs1C76Z8nT1Ay5c/V5FYYMKECROmWzAlS1zcQo0foE0gcsToMBAmTJgwYTqQqb1BDpe3eqM3+YKRanFHTJgwYcJ0I6ZZsZo8QBuMN6Vvm4g82TMmTJgwYTqWKQmos9KxLXHzZvGmqN6U2ZgwYcKE6USm2QGdthj+CK58kHnVbodNXkyYMGHCdDjTpr3btmVnY9TZaHOVKGDChAkTplsw5eO9q04MzQJ/3oBO0o5koIsJEyZMmO7BtGmt7g/ZzIrY9rDRbFyKCRMmTJjOZZoBta3bGXSy3WSf+b2KYhsTJkyYMB3C9Civtqk6C8ntQaJ8z+0e/ih9MWHChAnTgUyzADkrazejx+SOV91rdWHChAkTprdkSgLq/pjOrK3crpYPKetnxIQJEyZMhzPtH69NKWa/mh3lafMjTJgwYcKEKS8dN8dxZsVtQlkX25gwYcKE6QcwJWPCtlN6bdN5c/DoCRYmTJgwYTqcKQmfm+bvLC3Iy922tK5fGCZMmDBhOpZpE4Dz2rA9Zpr/th1t5gdYMWHChAnT4Uy/ACjPWKnHUeopAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };



lazyScripts.push('//s95.cnzz.com/z_stat.php?id=1261860158&web_id=1261860158')

</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '小青年博客！';
            clearTimeout(titleTime);
        } else {
            document.title = '看似寻常最奇崛，成如容易却艰辛。';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



<script type="text/javascript">
    (function(p,u,s,h){
        p._pcq=p._pcq||[];
        p._pcq.push(['_currentTime',Date.now()]);
        s=u.createElement('script');
        s.type='text/javascript';
        s.async=true;
        s.src='https://cdn.pushcrew.com/js/84781173feeb9c46759523538d7dbfe0.js';
        h=u.getElementsByTagName('script')[0];
        h.parentNode.insertBefore(s,h);
    })(window,document);
</script>

</body>
</html>
