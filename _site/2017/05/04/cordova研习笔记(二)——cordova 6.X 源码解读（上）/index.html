<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>cordova研习笔记(二) —— cordova 6.X 源码解读 | 小青年博客 | 看似寻常最奇崛，成如容易却艰辛。</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="cordova,hybrid App">
    <meta name="description" content="前言cordova(PhoneGap) 是一个优秀的经典的中间件框架，网上对其源代码解读的文章确实不多，本系列文章试着解读一下，以便对cordova 框架的原理理解得更深入。本文源码为cordova android版本6.1.2。 源码结构我们使用IDE的代码折叠功能先从整体上把握代码结构。123456/** 版权申明及注释部分*/;(function() &amp;#123;  ...&amp;#125;)()">
<meta name="keywords" content="cordova,hybrid App">
<meta property="og:type" content="article">
<meta property="og:title" content="cordova研习笔记(二) —— cordova 6.X 源码解读">
<meta property="og:url" content="https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/index.html">
<meta property="og:site_name" content="小青年博客">
<meta property="og:description" content="前言cordova(PhoneGap) 是一个优秀的经典的中间件框架，网上对其源代码解读的文章确实不多，本系列文章试着解读一下，以便对cordova 框架的原理理解得更深入。本文源码为cordova android版本6.1.2。 源码结构我们使用IDE的代码折叠功能先从整体上把握代码结构。123456/** 版权申明及注释部分*/;(function() &amp;#123;  ...&amp;#125;)()">
<meta property="og:updated_time" content="2017-05-08T05:43:46.652Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="cordova研习笔记(二) —— cordova 6.X 源码解读">
<meta name="twitter:description" content="前言cordova(PhoneGap) 是一个优秀的经典的中间件框架，网上对其源代码解读的文章确实不多，本系列文章试着解读一下，以便对cordova 框架的原理理解得更深入。本文源码为cordova android版本6.1.2。 源码结构我们使用IDE的代码折叠功能先从整体上把握代码结构。123456/** 版权申明及注释部分*/;(function() &amp;#123;  ...&amp;#125;)()">
    
        <link rel="alternate" type="application/atom+xml" title="小青年博客" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">赵梦欢</h5>
          <a href="mailto:zhaomenghuan@foxmail.com" title="zhaomenghuan@foxmail.com" class="mail">zhaomenghuan@foxmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://zhaomenghuan.github.io/content.json" target="_blank" >
                <i class="icon icon-lg icon-th-large"></i>
                API
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/zhaomenghuan" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                GitHub
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://segmentfault.com/u/zhaomenghuan" target="_blank" >
                <i class="icon icon-lg icon-link"></i>
                Segmentfault
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://www.jianshu.com/u/de1f0b8eaf18" target="_blank" >
                <i class="icon icon-lg icon-book"></i>
                简书
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">cordova研习笔记(二) —— cordova 6.X 源码解读</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">cordova研习笔记(二) —— cordova 6.X 源码解读</h1>
        <h5 class="subtitle">
            
                <time datetime="2017-05-03T16:00:00.000Z" itemprop="datePublished" class="page-time">
  2017-05-04
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/hybrid-App深入浅出研究/">hybrid App深入浅出研究</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前言"><span class="post-toc-number">1.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#源码结构"><span class="post-toc-number">2.</span> <span class="post-toc-text">源码结构</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#模块机制"><span class="post-toc-number">3.</span> <span class="post-toc-text">模块机制</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#事件通道"><span class="post-toc-number">4.</span> <span class="post-toc-text">事件通道</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#工具模块"><span class="post-toc-number">5.</span> <span class="post-toc-text">工具模块</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#cordova-模块"><span class="post-toc-number">6.</span> <span class="post-toc-text">cordova 模块</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考"><span class="post-toc-number">7.</span> <span class="post-toc-text">参考</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#写在后面"><span class="post-toc-number">8.</span> <span class="post-toc-text">写在后面</span></a></li></ol>
        </nav>
    </aside>
    
<article id="post-cordova研习笔记(二)——cordova 6.X 源码解读（上）"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">cordova研习笔记(二) —— cordova 6.X 源码解读</h1>
        <div class="post-meta">
            <time class="post-time" title="2017-05-04 00:00:00" datetime="2017-05-03T16:00:00.000Z"  itemprop="datePublished">2017-05-04</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/hybrid-App深入浅出研究/">hybrid App深入浅出研究</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>cordova(PhoneGap) 是一个优秀的经典的中间件框架，网上对其源代码解读的文章确实不多，本系列文章试着解读一下，以便对cordova 框架的原理理解得更深入。本文源码为cordova android版本<code>6.1.2</code>。</p>
<h2 id="源码结构"><a href="#源码结构" class="headerlink" title="源码结构"></a>源码结构</h2><p>我们使用IDE的代码折叠功能先从整体上把握代码结构。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">* 版权申明及注释部分</div><div class="line">*/</div><div class="line">;(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  ...</div><div class="line">&#125;)();</div></pre></td></tr></table></figure></p>
<p><code>;</code>是保证导入的其它js脚本，使用工具压缩js文件时不出错。一个自执行匿名函数包裹，防止内部变量污染到外部命名空间。阅读过jQuery源码的人都知道，jQuery的也是相同的结构，只是jQuery定义的匿名函数多了两个参数window和undefined，然后调用的时候只传入window，这样，window可以在jQuery内部安全使用，而undefined也的确表示未定义（有些浏览器实现允许重定义undefined）。</p>
<p>继续展开代码，可以看到如下的结构：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">;(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">var</span> PLATFORM_VERSION_BUILD_LABEL = <span class="string">'6.1.2'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 模块化系统</span></div><div class="line"><span class="comment">/* ------------------------------------------------------------- */</span></div><div class="line"><span class="keyword">var</span> <span class="built_in">require</span>, <span class="comment">// 加载使用module</span></div><div class="line">    define;  <span class="comment">// 定义注册module</span></div><div class="line"></div><div class="line"><span class="comment">// require|define 的逻辑</span></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  ...</div><div class="line">&#125;)();</div><div class="line"></div><div class="line"><span class="comment">// Export for use in node</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">module</span> === <span class="string">"object"</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">require</span> === <span class="string">"function"</span>) &#123;</div><div class="line">    <span class="built_in">module</span>.exports.require = <span class="built_in">require</span>;</div><div class="line">    <span class="built_in">module</span>.exports.define = define;</div><div class="line">&#125;</div><div class="line"><span class="comment">/* ------------------------------------------------------------- */</span></div><div class="line"></div><div class="line"><span class="comment">// 事件的处理和回调，外部访问cordova.js的入口</span></div><div class="line">define(<span class="string">"cordova"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// JS-&gt;Native的具体交互形式</span></div><div class="line">define(<span class="string">"cordova/android/nativeapiprovider"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 通过prompt()和Native交互</span></div><div class="line">define(<span class="string">"cordova/android/promptbasednativeapi"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>)  </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 用于plugin中校验参数，比如argscheck.checkArgs('fFO', 'Camera.getPicture', arguments); 参数应该是2个函数1个对象</span></div><div class="line">define(<span class="string">"cordova/argscheck"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// JS-&gt;Native交互时对ArrayBuffer进行uint8ToBase64（WebSockets二进制流）</span></div><div class="line">define(<span class="string">"cordova/base64"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 对象属性操作，比如把一个对象的属性Merge到另外一个对象</span></div><div class="line">define(<span class="string">"cordova/builder"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 事件通道</span></div><div class="line">define(<span class="string">"cordova/channel"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 执行JS-&gt;Native交互</span></div><div class="line">define(<span class="string">"cordova/exec"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 用于Plugin中往已经有的模块上添加方法</span></div><div class="line">define(<span class="string">"cordova/exec/proxy"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 初始化处理</span></div><div class="line">define(<span class="string">"cordova/init"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line">define(<span class="string">"cordova/init_b"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 把定义的模块clobber到一个对象，在初始化的时候会赋给window</span></div><div class="line">define(<span class="string">"cordova/modulemapper"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line">define(<span class="string">"cordova/modulemapper_b"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 平台启动处理</span></div><div class="line">define(<span class="string">"cordova/platform"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 清缓存、loadUrl、退出程序等</span></div><div class="line">define(<span class="string">"cordova/plugin/android/app"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 载所有cordova_plugins.js中定义的模块，执行完成后会触发</span></div><div class="line">define(<span class="string">"cordova/pluginloader"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line">define(<span class="string">"cordova/pluginloader_b"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 获取绝对URL，InAppBrowser中会用到</span></div><div class="line">define(<span class="string">"cordova/urlutil"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 工具类</span></div><div class="line">define(<span class="string">"cordova/utils"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123; ... &#125;</div><div class="line"></div><div class="line"><span class="comment">// 所有模块注册完之后，导入cordova至全局环境中</span></div><div class="line"><span class="built_in">window</span>.cordova = <span class="built_in">require</span>(<span class="string">'cordova'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 初始化启动</span></div><div class="line"><span class="built_in">require</span>(<span class="string">'cordova/init'</span>);</div></pre></td></tr></table></figure>
<p>从上可以清晰的看出，在cordova内部，首先是定义了两个公共的require和define函数，然后是使用define注册所有模块，再通过window.cordova=require(‘cordova’)导入库文件至全局执行环境中。</p>
<h2 id="模块机制"><a href="#模块机制" class="headerlink" title="模块机制"></a>模块机制</h2><p>类似于Java的package/import，在JavaScript中也有类似的define/require，它用来异步加载module化的js，从而提高运行效率。模块化加载的必要性，起源于nodejs的出现。但是JavaScript并没有内置模块系统，所以就出现了很多规范。 主要有2种：<a href="http://wiki.commonjs.org/wiki/Modules/1.1" target="_blank" rel="external">CommonJS</a> 和 <a href="http://en.wikipedia.org/wiki/Asynchronous_module_definition" target="_blank" rel="external">AMD（Asynchronous Module Definition）</a>。还有国内兴起的<a href="https://github.com/cmdjs/specification/blob/master/draft/module.md" target="_blank" rel="external">CMD（Common Module Definition）</a> 。CommonJS主要面对的是服务器，代表是<a href="http://nodejs.org/" target="_blank" rel="external">Node.js</a>；AMD针对浏览器进行了优化，主要实现<a href="http://www.requirejs.org/" target="_blank" rel="external">require.js</a>；CMD是<a href="http://seajs.org/docs/" target="_blank" rel="external">seajs</a>。 </p>
<p>cordova-js最开始采用的是require.js作者写的<a href="http://github.com/jrburke/almond" target="_blank" rel="external">almond.js</a>（兼容AMD和CommonJS），但之后由于特殊需求（比如模块不存在的时候要throw异常），最终从almond.js fork过来实现了一个简易CommonJS风格的模块系统，同时提供了和nodejs之间很好的交互。在cordova.js中可以直接使用define()和require()，在其他文件可以通过cordova.define()和cordova.require()来调用。所以src/scripts/require.js中定义的就是一个精简的JavaScript模块系统。 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// cordova.js内部使用的全局函数require/define</span></div><div class="line"><span class="keyword">var</span> <span class="built_in">require</span>,</div><div class="line">    define;</div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// 初始化一个空对象，缓存所有的模块</span></div><div class="line">    <span class="keyword">var</span> modules = &#123;&#125;,</div><div class="line">    <span class="comment">// 正在build中的模块ID的栈</span></div><div class="line">        requireStack = [],</div><div class="line">    <span class="comment">// 标示正在build中模块ID的Map</span></div><div class="line">        inProgressModules = &#123;&#125;,</div><div class="line">        SEPARATOR = <span class="string">"."</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 模块build</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">build</span>(<span class="params">module</span>) </span>&#123;</div><div class="line">        <span class="comment">// 备份工厂方法</span></div><div class="line">        <span class="keyword">var</span> factory = <span class="built_in">module</span>.factory,</div><div class="line">        <span class="comment">// 对require对象进行特殊处理 </span></div><div class="line">            localRequire = <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</div><div class="line">                <span class="keyword">var</span> resultantId = id;</div><div class="line">                <span class="comment">//Its a relative path, so lop off the last portion and add the id (minus "./")</span></div><div class="line">                <span class="keyword">if</span> (id.charAt(<span class="number">0</span>) === <span class="string">"."</span>) &#123;</div><div class="line">                    resultantId = <span class="built_in">module</span>.id.slice(<span class="number">0</span>, <span class="built_in">module</span>.id.lastIndexOf(SEPARATOR)) + SEPARATOR + id.slice(<span class="number">2</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="built_in">require</span>(resultantId);</div><div class="line">            &#125;;</div><div class="line">        <span class="comment">// 给模块定义一个空的exports对象，防止工厂类方法中的空引用</span></div><div class="line">        <span class="built_in">module</span>.exports = &#123;&#125;;</div><div class="line">        <span class="comment">// 删除工厂方法</span></div><div class="line">        <span class="keyword">delete</span> <span class="built_in">module</span>.factory;</div><div class="line">        <span class="comment">// 调用备份的工厂方法（参数必须是require,exports,module）  </span></div><div class="line">        factory(localRequire, <span class="built_in">module</span>.exports, <span class="built_in">module</span>);</div><div class="line">        <span class="comment">// 返回工厂方法中实现的module.exports对象</span></div><div class="line">        <span class="keyword">return</span> <span class="built_in">module</span>.exports;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 加载使用模块</span></div><div class="line">    <span class="built_in">require</span> = <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</div><div class="line">        <span class="comment">// 如果模块不存在抛出异常 </span></div><div class="line">        <span class="keyword">if</span> (!modules[id]) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="string">"module "</span> + id + <span class="string">" not found"</span>;</div><div class="line">        <span class="comment">// 如果模块正在build中抛出异常</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (id <span class="keyword">in</span> inProgressModules) &#123;</div><div class="line">            <span class="keyword">var</span> cycle = requireStack.slice(inProgressModules[id]).join(<span class="string">'-&gt;'</span>) + <span class="string">'-&gt;'</span> + id;</div><div class="line">            <span class="keyword">throw</span> <span class="string">"Cycle in require graph: "</span> + cycle;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 如果模块存在工厂方法说明还未进行build（require嵌套）</span></div><div class="line">        <span class="keyword">if</span> (modules[id].factory) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 标示该模块正在build</span></div><div class="line">                inProgressModules[id] = requireStack.length;</div><div class="line">                <span class="comment">// 将该模块压入请求栈</span></div><div class="line">                requireStack.push(id);</div><div class="line">                <span class="comment">// 模块build，成功后返回module.exports</span></div><div class="line">                <span class="keyword">return</span> build(modules[id]);</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="comment">// build完成后删除当前请求</span></div><div class="line">                <span class="keyword">delete</span> inProgressModules[id];</div><div class="line">                requireStack.pop();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// build完的模块直接返回module.exports  </span></div><div class="line">        <span class="keyword">return</span> modules[id].exports;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="comment">// 定义注册模块</span></div><div class="line">    define = <span class="function"><span class="keyword">function</span> (<span class="params">id, factory</span>) </span>&#123;</div><div class="line">        <span class="comment">// 如果已经存在抛出异常</span></div><div class="line">        <span class="keyword">if</span> (modules[id]) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="string">"module "</span> + id + <span class="string">" already defined"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 模块以ID为索引包含ID和工厂方法</span></div><div class="line">        modules[id] = &#123;</div><div class="line">            <span class="attr">id</span>: id,</div><div class="line">            <span class="attr">factory</span>: factory</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="comment">// 移除模块</span></div><div class="line">    define.remove = <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</div><div class="line">        <span class="keyword">delete</span> modules[id];</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="comment">// 返回所有模块</span></div><div class="line">    define.moduleMap = modules;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>首先在外部cordova环境中定义require和define两个变量，用来存储实现导入功能的函数和实现注册功能的函数。然后用一个立即调用的匿名函数来实例化这两个变量，在这个匿名函数内部，缓存了所有的功能模块。注册模块时，如果已经注册了，就直接抛出异常，防止无意中重定义，如确实需要重定义，可先调用define.remove。</p>
<p>从内部私有函数build中，可以看出，调用工厂函数时， <code>factory(localRequire, module.exports, module);</code>第一个参数<code>localRequire</code>实质还是调用全局的<code>require()</code>函数，只是把ID稍微加工了一下支持相对路径。cordova.js没有用到相对路径的require，但在一些Plugin的js中有，比如<code>Contact.js</code> 中 <code>ContactError = require(&#39;./ContactError&#39;);</code></p>
<p>这里我们写个测试用例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;script src=<span class="string">"module.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</div><div class="line">    define(<span class="string">'plugin.first'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">require, exports, module</span>) </span>&#123;</div><div class="line">        <span class="built_in">module</span>.exports = &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'first plugin'</span>,</div><div class="line">            <span class="attr">show</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="built_in">console</span>.log(<span class="string">"call "</span>+<span class="keyword">this</span>.name);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    define(<span class="string">'plugin.second'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">require, exports, module</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> first = <span class="built_in">require</span>(<span class="string">"plugin.first"</span>);</div><div class="line">        first.show();</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="built_in">require</span>(<span class="string">"plugin.second"</span>); </div><div class="line">    <span class="comment">// call first plugin</span></div><div class="line">&lt;<span class="regexp">/script&gt;</span></div></pre></td></tr></table></figure></p>
<p>注：module.js为上述cordova的模块代码。</p>
<p>上面例子中我们定义了两个模块，这里是写在同一个页面下，在实际中我们自然希望写在两个不同的文件中，然后按需加载。我们上一篇文章中说明了cordova的插件使用方法，我们会发现<code>cordova_plugins.js</code>中定义了cordova插件的id、路径等变量，并且该文件定义了一个id为<code>cordova/plugin_list</code>的模块，我们在cordova.js中可以看到有这个模块的引用。</p>
<p>定义了require和define并赋值后，是将cordova所有模块一一注册，例如：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">define(<span class="string">"cordova"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">require,exports,module</span>)</span>&#123;</div><div class="line">  <span class="comment">// 工厂函数内部实现代码</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>这里需要注意的是，<strong>define只是注册模块，不会调用其factory。</strong>factory函数在这个时候并没有实际执行，而只是定义，并作为一个参数传递给define函数。所有模块注册完之后，通过：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>.cordova = <span class="built_in">require</span>(<span class="string">'cordova'</span>);</div></pre></td></tr></table></figure></p>
<p>导入至全局环境。</p>
<p>因为是注册后第一次导入，所以在执行<code>require(&#39;cordova&#39;)</code>时，<code>modules[&#39;cordova&#39;].factory</code>的值是注册时的工厂函数，转变为boolean值时为true，从而在这里会通过build调用这个工厂函数，并将这个工厂函数从注册缓存里面删除，接下来的就是去执行cordova的这个factory函数了。</p>
<h2 id="事件通道"><a href="#事件通道" class="headerlink" title="事件通道"></a>事件通道</h2><p>作为观察者模式(Observer)的一种变形，很多MV*框架（比如：Vue.js、Backbone.js）中都提供发布/订阅模型来对代码进行解耦。cordova.js中也提供了一个自定义的pub-sub模型，基于该模型提供了一些事件通道，用来控制通道中的事件什么时候以什么样的顺序被调用，以及各个事件通道的调用。</p>
<p>src/common/channel.js的代码结构也是一个很经典的定义结构（构造函数、实例、修改函数原型共享实例方法），它提供事件通道上事件的订阅（subscribe）、撤消订阅（unsubscribe）、调用（fire）。pub-sub模型用于定义和控制对cordova初始化的事件的触发以及此后的自定义事件。</p>
<p>页面加载和Cordova启动期间的事件顺序如下：</p>
<ul>
<li><strong>onDOMContentLoaded</strong> ——（内部事件通道）页面加载后DOM解析完成 </li>
<li><strong>onNativeReady</strong> ——（内部事件通道）Cordova的native准备完成</li>
<li><strong>onCordovaReady</strong> ——（内部事件通道）所有Cordova的JavaScript对象被创建完成可以开始加载插件</li>
<li><strong>onDeviceReady</strong> —— Cordova全部准备完成   </li>
<li><strong>onResume</strong> —— 应用重新返回前台</li>
<li><strong>onPause</strong> —— 应用暂停退到后台</li>
</ul>
<p>可以通过下面的事件进行监听：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">document</span>.addEventListener(<span class="string">"deviceready"</span>, myDeviceReadyListener, <span class="literal">false</span>);</div><div class="line"><span class="built_in">document</span>.addEventListener(<span class="string">"resume"</span>, myResumeListener, <span class="literal">false</span>);</div><div class="line"><span class="built_in">document</span>.addEventListener(<span class="string">"pause"</span>, myPauseListener, <span class="literal">false</span>);</div></pre></td></tr></table></figure></p>
<p>DOM生命周期事件应用于保存和恢复状态：</p>
<ul>
<li>window.onload</li>
<li>window.onunload</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div></pre></td><td class="code"><pre><div class="line">define(<span class="string">"cordova/channel"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> utils = <span class="built_in">require</span>(<span class="string">'cordova/utils'</span>),</div><div class="line">        nextGuid = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 事件通道的构造函数</span></div><div class="line">    <span class="keyword">var</span> Channel = <span class="function"><span class="keyword">function</span>(<span class="params">type, sticky</span>) </span>&#123;</div><div class="line">        <span class="comment">// 通道名称</span></div><div class="line">        <span class="keyword">this</span>.type = type;</div><div class="line">        <span class="comment">// 通道上的所有事件处理函数Map（索引为guid）</span></div><div class="line">        <span class="keyword">this</span>.handlers = &#123;&#125;;</div><div class="line">        <span class="comment">// 通道的状态（0：非sticky, 1:sticky但未调用, 2:sticky已调用）  </span></div><div class="line">        <span class="keyword">this</span>.state = sticky ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">        <span class="comment">// 对于sticky事件通道备份传给fire()的参数 </span></div><div class="line">        <span class="keyword">this</span>.fireArgs = <span class="literal">null</span>;</div><div class="line">        <span class="comment">// 当前通道上的事件处理函数的个数</span></div><div class="line">        <span class="keyword">this</span>.numHandlers = <span class="number">0</span>;</div><div class="line">        <span class="comment">// 订阅第一个事件或者取消订阅最后一个事件时调用自定义的处理</span></div><div class="line">        <span class="keyword">this</span>.onHasSubscribersChange = <span class="literal">null</span>;</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 事件通道外部接口</span></div><div class="line">    channel = &#123;</div><div class="line">        <span class="comment">// 把指定的函数h订阅到c的各个通道上，保证h在每个通道的最后被执行  </span></div><div class="line">        join: <span class="function"><span class="keyword">function</span>(<span class="params">h, c</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> len = c.length,</div><div class="line">                i = len,</div><div class="line">                f = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (!(--i)) h();</div><div class="line">                &#125;;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> j=<span class="number">0</span>; j&lt;len; j++) &#123;</div><div class="line">                <span class="keyword">if</span> (c[j].state === <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">'Can only use join with sticky channels.'</span>);</div><div class="line">                &#125;</div><div class="line">                c[j].subscribe(f);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!len) h();</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// 创建事件通道</span></div><div class="line">        create: <span class="function"><span class="keyword">function</span>(<span class="params">type</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> channel[type] = <span class="keyword">new</span> Channel(type, <span class="literal">false</span>);</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// 创建sticky事件通道</span></div><div class="line">        createSticky: <span class="function"><span class="keyword">function</span>(<span class="params">type</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> channel[type] = <span class="keyword">new</span> Channel(type, <span class="literal">true</span>);</div><div class="line">        &#125;,</div><div class="line">    </div><div class="line">        <span class="comment">// 保存deviceready事件之前要调用的事件</span></div><div class="line">        deviceReadyChannelsArray: [],</div><div class="line">        <span class="attr">deviceReadyChannelsMap</span>: &#123;&#125;,</div><div class="line">    </div><div class="line">        <span class="comment">// 设置deviceready事件之前必须要完成的事件</span></div><div class="line">        waitForInitialization: <span class="function"><span class="keyword">function</span>(<span class="params">feature</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (feature) &#123;</div><div class="line">                <span class="keyword">var</span> c = channel[feature] || <span class="keyword">this</span>.createSticky(feature);</div><div class="line">                <span class="keyword">this</span>.deviceReadyChannelsMap[feature] = c;</div><div class="line">                <span class="keyword">this</span>.deviceReadyChannelsArray.push(c);</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">    </div><div class="line">        <span class="comment">// 初始化代码已经完成</span></div><div class="line">        initializationComplete: <span class="function"><span class="keyword">function</span>(<span class="params">feature</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> c = <span class="keyword">this</span>.deviceReadyChannelsMap[feature];</div><div class="line">            <span class="keyword">if</span> (c) &#123;</div><div class="line">                c.fire();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// 校验事件处理函数</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkSubscriptionArgument</span>(<span class="params">argument</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> argument !== <span class="string">"function"</span> &amp;&amp; <span class="keyword">typeof</span> argument.handleEvent !== <span class="string">"function"</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">                <span class="string">"Must provide a function or an EventListener object "</span> +</div><div class="line">                <span class="string">"implementing the handleEvent interface."</span></div><div class="line">            );</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 向事件通道订阅事件处理函数(subscribe部分）  </div><div class="line">     * f:事件处理函数 c:事件的上下文</div><div class="line">     */</div><div class="line">    Channel.prototype.subscribe = <span class="function"><span class="keyword">function</span>(<span class="params">eventListenerOrFunction, eventListener</span>) </span>&#123;</div><div class="line">        <span class="comment">// 校验事件处理函数</span></div><div class="line">        checkSubscriptionArgument(eventListenerOrFunction);</div><div class="line">        </div><div class="line">        <span class="keyword">var</span> handleEvent, guid;</div><div class="line">    </div><div class="line">        <span class="keyword">if</span> (eventListenerOrFunction &amp;&amp; <span class="keyword">typeof</span> eventListenerOrFunction === <span class="string">"object"</span>) &#123;</div><div class="line">            <span class="comment">// 接收到一个实现handleEvent接口的EventListener对象</span></div><div class="line">            handleEvent = eventListenerOrFunction.handleEvent;</div><div class="line">            eventListener = eventListenerOrFunction;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 接收到处理事件的回调函数</span></div><div class="line">            handleEvent = eventListenerOrFunction;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 如果是被订阅过的sticky事件，就直接调用</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state == <span class="number">2</span>) &#123;</div><div class="line">            handleEvent.apply(eventListener || <span class="keyword">this</span>, <span class="keyword">this</span>.fireArgs);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">        guid = eventListenerOrFunction.observer_guid;</div><div class="line">        <span class="comment">// 如果事件有上下文，要先把事件函数包装一下带上上下文</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> eventListener === <span class="string">"object"</span>) &#123;</div><div class="line">            handleEvent = utils.close(eventListener, handleEvent);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 自增长的ID</span></div><div class="line">        <span class="keyword">if</span> (!guid) &#123;</div><div class="line">            guid = <span class="string">''</span> + nextGuid++;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 把自增长的ID反向设置给函数，以后撤消订阅或内部查找用</span></div><div class="line">        handleEvent.observer_guid = guid;</div><div class="line">        eventListenerOrFunction.observer_guid = guid;</div><div class="line">    </div><div class="line">        <span class="comment">// 判断该guid索引的事件处理函数是否存在（保证订阅一次）</span></div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.handlers[guid]) &#123;</div><div class="line">            <span class="comment">// 订阅到该通道上（索引为guid）</span></div><div class="line">            <span class="keyword">this</span>.handlers[guid] = handleEvent;</div><div class="line">            <span class="comment">// 通道上的事件处理函数的个数增1 </span></div><div class="line">            <span class="keyword">this</span>.numHandlers++;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.numHandlers == <span class="number">1</span>) &#123;</div><div class="line">                <span class="comment">// 订阅第一个事件时调用自定义的处理（比如：第一次按下返回按钮提示“再按一次...”） </span></div><div class="line">                <span class="keyword">this</span>.onHasSubscribersChange &amp;&amp; <span class="keyword">this</span>.onHasSubscribersChange();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 撤消订阅通道上的某个函数（guid）</div><div class="line">     */</div><div class="line">    Channel.prototype.unsubscribe = <span class="function"><span class="keyword">function</span>(<span class="params">eventListenerOrFunction</span>) </span>&#123;</div><div class="line">         <span class="comment">// 事件处理函数校验</span></div><div class="line">        checkSubscriptionArgument(eventListenerOrFunction);</div><div class="line"></div><div class="line">        <span class="keyword">var</span> handleEvent, guid, handler;</div><div class="line">    </div><div class="line">        <span class="keyword">if</span> (eventListenerOrFunction &amp;&amp; <span class="keyword">typeof</span> eventListenerOrFunction === <span class="string">"object"</span>) &#123;</div><div class="line">            <span class="comment">// 接收到一个实现handleEvent接口的EventListener对象</span></div><div class="line">            handleEvent = eventListenerOrFunction.handleEvent;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 接收到处理事件的回调函数</span></div><div class="line">            handleEvent = eventListenerOrFunction;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 事件处理函数的guid索引</span></div><div class="line">        guid = handleEvent.observer_guid;</div><div class="line">        <span class="comment">// 事件处理函数</span></div><div class="line">        handler = <span class="keyword">this</span>.handlers[guid];</div><div class="line">        <span class="keyword">if</span> (handler) &#123;</div><div class="line">            <span class="comment">// 从该通道上撤消订阅（索引为guid）</span></div><div class="line">            <span class="keyword">delete</span> <span class="keyword">this</span>.handlers[guid];</div><div class="line">            <span class="comment">// 通道上的事件处理函数的个数减1</span></div><div class="line">            <span class="keyword">this</span>.numHandlers--;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.numHandlers === <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// 撤消订阅最后一个事件时调用自定义的处理</span></div><div class="line">                <span class="keyword">this</span>.onHasSubscribersChange &amp;&amp; <span class="keyword">this</span>.onHasSubscribersChange();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 调用所有被发布到该通道上的函数</div><div class="line">     */</div><div class="line">    Channel.prototype.fire = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> fail = <span class="literal">false</span>,</div><div class="line">            fireArgs = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>);</div><div class="line"></div><div class="line">        <span class="comment">// sticky事件被调用时，标示为已经调用过</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.state = <span class="number">2</span>;</div><div class="line">            <span class="keyword">this</span>.fireArgs = fireArgs;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.numHandlers) &#123;</div><div class="line">            <span class="comment">// 把该通道上的所有事件处理函数拿出来放到一个数组中</span></div><div class="line">            <span class="keyword">var</span> toCall = [];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> item <span class="keyword">in</span> <span class="keyword">this</span>.handlers) &#123;</div><div class="line">                toCall.push(<span class="keyword">this</span>.handlers[item]);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 依次调用通道上的所有事件处理函数</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; toCall.length; ++i) &#123;</div><div class="line">                toCall[i].apply(<span class="keyword">this</span>, fireArgs);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// sticky事件是一次性全部被调用的，调用完成后就清空</span></div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.state == <span class="number">2</span> &amp;&amp; <span class="keyword">this</span>.numHandlers) &#123;</div><div class="line">                <span class="keyword">this</span>.numHandlers = <span class="number">0</span>;</div><div class="line">                <span class="keyword">this</span>.handlers = &#123;&#125;;</div><div class="line">                <span class="keyword">this</span>.onHasSubscribersChange &amp;&amp; <span class="keyword">this</span>.onHasSubscribersChange();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 创建事件通道（publish部分）</div><div class="line">     */</div><div class="line">    <span class="comment">//（内部事件通道）页面加载后DOM解析完成</span></div><div class="line">    channel.createSticky(<span class="string">'onDOMContentLoaded'</span>);</div><div class="line">    </div><div class="line">    <span class="comment">//（内部事件通道）Cordova的native准备完成</span></div><div class="line">    channel.createSticky(<span class="string">'onNativeReady'</span>);</div><div class="line">    </div><div class="line">    <span class="comment">//（内部事件通道）所有Cordova的JavaScript对象被创建完成可以开始加载插件  </span></div><div class="line">    channel.createSticky(<span class="string">'onCordovaReady'</span>);</div><div class="line">    </div><div class="line">    <span class="comment">//（内部事件通道）所有自动load的插件js已经被加载完成（待删除）</span></div><div class="line">    channel.createSticky(<span class="string">'onPluginsReady'</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// Cordova全部准备完成</span></div><div class="line">    channel.createSticky(<span class="string">'onDeviceReady'</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// 应用重新返回前台</span></div><div class="line">    channel.create(<span class="string">'onResume'</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// 应用暂停退到后台</span></div><div class="line">    channel.create(<span class="string">'onPause'</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// 设置deviceready事件之前必须要完成的事件</span></div><div class="line">    channel.waitForInitialization(<span class="string">'onCordovaReady'</span>);</div><div class="line">    channel.waitForInitialization(<span class="string">'onDOMContentLoaded'</span>);</div><div class="line">    </div><div class="line">    <span class="built_in">module</span>.exports = channel;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们可以写一个测试用例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;script src=<span class="string">"channel.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div><div class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</div><div class="line">    <span class="keyword">var</span> test = channel.create(<span class="string">'onTest'</span>);</div><div class="line">    <span class="comment">// 订阅事件（此处test = channel.onTest）</span></div><div class="line">    test.subscribe(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'test fire'</span>);</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// 触发事件（此处test = channel.onTest）</span></div><div class="line">    test.fire();</div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div></pre></td></tr></table></figure></p>
<p>但是很多时候我们希望能够传递参数，通过阅读上面的源码可以得知：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (eventListenerOrFunction &amp;&amp; <span class="keyword">typeof</span> eventListenerOrFunction === <span class="string">"object"</span>) &#123;</div><div class="line">    <span class="comment">// 接收到一个实现handleEvent接口的EventListener对象</span></div><div class="line">    handleEvent = eventListenerOrFunction.handleEvent;</div><div class="line">   eventListener = eventListenerOrFunction;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">   <span class="comment">// 接收到处理事件的回调函数</span></div><div class="line">   handleEvent = eventListenerOrFunction;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们上面的例子中我们传递的是一个方法，这里我们也可以传递一个EventListener对象。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建事件通道</span></div><div class="line">channel.create(<span class="string">'onTest'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 订阅事件</span></div><div class="line">channel.onTest.subscribe(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(event);</div><div class="line">  <span class="built_in">console</span>.log(event.data.name+<span class="string">' fire'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 创建 Event 对象</span></div><div class="line"><span class="keyword">var</span> event = <span class="built_in">document</span>.createEvent(<span class="string">'Events'</span>);</div><div class="line"><span class="comment">// 初始化事件</span></div><div class="line">event.initEvent(<span class="string">'onTest'</span>, <span class="literal">false</span>, <span class="literal">false</span>);</div><div class="line"><span class="comment">// 绑定数据</span></div><div class="line">event.data = &#123;<span class="attr">name</span>: <span class="string">'test'</span>&#125;;</div><div class="line"><span class="comment">// 触发事件</span></div><div class="line">channel.onTest.fire(event);</div></pre></td></tr></table></figure></p>
<h2 id="工具模块"><a href="#工具模块" class="headerlink" title="工具模块"></a>工具模块</h2><p>我们在写插件的时候如果熟悉cordova自带的工具函数，可以更加方便的拓展自己的插件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">define(<span class="string">"cordova/utils"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> utils = exports;</div><div class="line">    <span class="comment">// 定义对象属性（或方法）的setter/getter</span></div><div class="line">    utils.defineGetterSetter = <span class="function"><span class="keyword">function</span>(<span class="params">obj, key, getFunc, opt_setFunc</span>) </span>&#123;...&#125;</div><div class="line">    <span class="comment">// 定义对象属性（或方法）的getter</span></div><div class="line">    utils.defineGetter = utils.defineGetterSetter;</div><div class="line">    <span class="comment">// Array IndexOf 方法</span></div><div class="line">    utils.arrayIndexOf = <span class="function"><span class="keyword">function</span>(<span class="params">a, item</span>) </span>&#123;...&#125;</div><div class="line">    <span class="comment">// Array remove 方法</span></div><div class="line">    utils.arrayRemove = <span class="function"><span class="keyword">function</span>(<span class="params">a, item</span>) </span>&#123;...&#125;</div><div class="line">    <span class="comment">// 类型判断</span></div><div class="line">    utils.typeName = <span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;...&#125;</div><div class="line">    <span class="comment">// 数组判断</span></div><div class="line">    utils.isArray = <span class="built_in">Array</span>.isArray ||</div><div class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;<span class="keyword">return</span> utils.typeName(a) == <span class="string">'Array'</span>;&#125;;</div><div class="line">    <span class="comment">// Date判断</span></div><div class="line">    utils.isDate = <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;...&#125;</div><div class="line">    <span class="comment">// 深度拷贝</span></div><div class="line">    utils.clone = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;...&#125;</div><div class="line">    <span class="comment">// 函数包装调用</span></div><div class="line">    utils.close = <span class="function"><span class="keyword">function</span>(<span class="params">context, func, params</span>) </span>&#123;...&#125;</div><div class="line">    <span class="comment">//  内部私有函数，产生随机数</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">UUIDcreatePart</span>(<span class="params">length</span>) </span>&#123;...&#125;</div><div class="line">    <span class="comment">// 创建 UUID (通用唯一识别码)</span></div><div class="line">    utils.createUUID = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;...&#125;</div><div class="line">    <span class="comment">// 继承</span></div><div class="line">    utils.extend = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;...&#125;</div><div class="line">    <span class="comment">// 调试</span></div><div class="line">    utils.alert = <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;...&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>UUIDcreatePart函数用来随机产生一个16进制的号码，接受一个表示号码长度的参数（实际上是最终号码长度的一半），一般用途是做为元素的唯一ID。</li>
<li>utils.isArray 在这里不使用instanceof来判断是不是Array类型，主要是考虑到跨域或者多个frame的情况，多个frame时每个frame都会有自己的Array构造函数，从而得出不正确的结论。使用’[object Array]’来判断是根据ECMA标准中的返回值来进行的，事实上，这里不需要类型转换，而可以用全等“===”来判断。</li>
<li>utils.close函数，封装函数的调用，将执行环境作为一个参数，调用的函数为第二个参数，调用函数本身的参数为后续参数。</li>
</ul>
<p><strong>原型继承实现详解</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">utils.extend = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// proxy used to establish prototype chain</span></div><div class="line">    <span class="keyword">var</span> F = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;;</div><div class="line">    <span class="comment">// extend Child from Parent</span></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">Child, Parent</span>) </span>&#123;</div><div class="line"></div><div class="line">        F.prototype = Parent.prototype;</div><div class="line">        Child.prototype = <span class="keyword">new</span> F();</div><div class="line">        Child.__super__ = Parent.prototype;</div><div class="line">        Child.prototype.constructor = Child;</div><div class="line">    &#125;;</div><div class="line">&#125;());</div></pre></td></tr></table></figure>
<p>这里的继承是通过原型链的方式实现，我们可以通过下述方式调用：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Parent = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.name = <span class="string">'Parent'</span>;</div><div class="line">&#125;</div><div class="line">Parent.prototype.getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.name;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> Child = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.name = <span class="string">'Child'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">utils.extend(Child, Parent);</div><div class="line"></div><div class="line"><span class="keyword">var</span> child = <span class="keyword">new</span> Child();</div><div class="line"><span class="built_in">console</span>.log(child.getName())</div></pre></td></tr></table></figure></p>
<p>ES5中有一个<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object/create" target="_blank" rel="external">Object.create</a>方法，我们可以使用这个函数实现继承：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建一个新的对象</span></div><div class="line"><span class="built_in">Object</span>.create = <span class="built_in">Object</span>.create || <span class="function"><span class="keyword">function</span> (<span class="params">proto</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> F = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</div><div class="line">    F.prototype = proto;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> F();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现继承</span></div><div class="line"><span class="keyword">var</span> extend = <span class="function"><span class="keyword">function</span>(<span class="params">Child, Parent</span>) </span>&#123;</div><div class="line">    <span class="comment">// 拷贝Parent原型对象</span></div><div class="line">    Child.prototype = <span class="built_in">Object</span>.create(Parent.prototype);</div><div class="line">    <span class="comment">// 将Child构造函</span></div><div class="line">    Child.prototype.constructor = Child;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实例</span></div><div class="line"><span class="keyword">var</span> Parent = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.name = <span class="string">'Parent'</span>;</div><div class="line">&#125;</div><div class="line">Parent.prototype.getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.name;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> Child = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.name = <span class="string">'Child'</span>;</div><div class="line">&#125;</div><div class="line">extend(Child, Parent);</div><div class="line"><span class="keyword">var</span> child = <span class="keyword">new</span> Child();</div><div class="line"><span class="built_in">console</span>.log(child.getName())</div></pre></td></tr></table></figure></p>
<p>原型链的概念对于初学者而言可能有点绕，但是我们把握<strong>构造函数</strong>、<strong>实例化对象</strong>、<strong>原型对象</strong>三者的关系就很简单了。我们以此为例说明：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 构造函数</span></div><div class="line"><span class="keyword">var</span> Child = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.name = <span class="string">'Child'</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 原型对象Child.prototype</span></div><div class="line">Child.prototype.getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.name;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 实例化对象</span></div><div class="line"><span class="keyword">var</span> child = <span class="keyword">new</span> Child();</div></pre></td></tr></table></figure></p>
<ul>
<li>原型对象是构造函数的prototype属性，是所有实例化对象共享属性和方法的原型对象。</li>
<li>实例化对象通过new构造函数得到，都继承了原型对象的属性和方法。</li>
<li><p>如何访（qiu）问（jie）原型对象？若已知构造函数Child，则可以通过<code>Child.prototype</code>得到；若已知实例化对象child，则可以通过<code>child.__proto__</code>或者<code>Object.getPrototypeOf(child)</code>得到，也通过Object.setPrototypeOf方法来重写对象的原型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Child.prototype === child.__proto__  <span class="comment">// true</span></div><div class="line">child.__proto__ === <span class="built_in">Object</span>.getPrototypeOf(child) <span class="comment">// true</span></div></pre></td></tr></table></figure>
</li>
<li><p>原型对象中有个隐式的constructor，指向了构造函数本身，也就是我们可以通过<code>Child.prototype.constructor</code>（虽然看似多此一举，但是经常需要重新设置构造函数）或<code>child.__proto__.constructor</code>或者<code>Object.getPrototypeOf(child).constructor</code>得到构造函数。</p>
</li>
<li>instanceof和Object.isPrototypeOf()可以判断两个对象是否是继承关系<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">child <span class="keyword">instanceof</span> Child  <span class="comment">// true</span></div><div class="line">Child.prototype.isPrototypeOf(child) <span class="comment">// true</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>至此<strong>构造函数</strong>、<strong>实例化对象</strong>、<strong>原型对象</strong>三者的关系我们已经很清除了，再回过头看看上面继承的实现就很简单了。</p>
<p>我们可以通过<code>instanceof</code>来检验是否满足继承关系：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">child <span class="keyword">instanceof</span> Child &amp;&amp; child <span class="keyword">instanceof</span> Parent  <span class="comment">// true</span></div></pre></td></tr></table></figure></p>
<p>其实上述继承的思路很简单：<br>1.首先获得父类原型对象的方法，这里的F对象作为中间变量引用拷贝Parent.prototype对象（即和Parent.prototype共享同一内存空间）；例如我们修改上述的Object.create为：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.create = <span class="function"><span class="keyword">function</span> (<span class="params">proto</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> F = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</div><div class="line">    F.prototype = proto;</div><div class="line">    F.prototype.setName = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> F();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>此时Parent.prototype、Child.prototype、child都拥有的setName方法，但是我们应当避免这样做，这也是为什么我们不直接通过<code>Child.prototype = Parent.prototype</code>获得；通过实例化中间对象F间接得到Parent.prototype的方法，此时通过Object.create方法获得的对象和Parent.prototype不再是共享内存空间。Child通过<code>extend(Child, Parent)</code>从Parent.prototype对象获得一份新的拷贝。实质是因为我们通过new一个构造函数获得的实例化对象是获得了一个新的内存空间，子对象互不影响；<br>2.对子类进行修正，我们通过拷贝获得了父类的一个备份，此时子类原型对象下的constructor属性依然是父类的构造函数，显然不符合我们的要求，我们需要重置，同时有时候我们希望保留对父类的引用，如cordova这里用一个<code>__super__</code>属性保存。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Child.__super__ = Parent.prototype;</div><div class="line">Child.prototype.constructor = Child;</div></pre></td></tr></table></figure></p>
<p>其实继承的本质我们是希望能实现以下功能：</p>
<ul>
<li>父类有的我都有，我也能重载，但不至于影响到父类的属性和方法</li>
<li>除了继承之外，我也能添加自己的方法和属性</li>
</ul>
<p>我们可以利用es6新特性实现同样的效果：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span> () &#123;</div><div class="line">        <span class="keyword">this</span>.name = <span class="string">'Parent'</span>;</div><div class="line">    &#125;</div><div class="line">    getName () &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">Parent</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span> () &#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">this</span>.name = <span class="string">'Child'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> child = <span class="keyword">new</span> Child();</div><div class="line"><span class="built_in">console</span>.log(child.getName())</div></pre></td></tr></table></figure></p>
<p>super关键字在这里表示父类的构造函数，用来新建父类的this对象。在子类的构造函数中，只有调用super之后，才可以使用this关键字，否则会报错。这是因为子类实例的构建，是基于对父类实例加工，只有super方法才能返回父类实例。</p>
<h2 id="cordova-模块"><a href="#cordova-模块" class="headerlink" title="cordova 模块"></a>cordova 模块</h2><p>本文最后一部分我们来看看cordova模块，cordova模块是事件的处理和回调，外部访问cordova.js的入口。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">define(<span class="string">"cordova"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.cordova &amp;&amp; !(<span class="built_in">window</span>.cordova <span class="keyword">instanceof</span> HTMLElement)) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"cordova already defined"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 导入事件通道模块</span></div><div class="line">  <span class="keyword">var</span> channel = <span class="built_in">require</span>(<span class="string">'cordova/channel'</span>);</div><div class="line">  <span class="comment">// 导入平台模块</span></div><div class="line">  <span class="keyword">var</span> platform = <span class="built_in">require</span>(<span class="string">'cordova/platform'</span>);</div><div class="line">  <span class="comment">// 保存addEventListener、removeEventListener的原生实现</span></div><div class="line">  <span class="keyword">var</span> m_document_addEventListener = <span class="built_in">document</span>.addEventListener;</div><div class="line">  <span class="keyword">var</span> m_document_removeEventListener = <span class="built_in">document</span>.removeEventListener;</div><div class="line">  <span class="keyword">var</span> m_window_addEventListener = <span class="built_in">window</span>.addEventListener;</div><div class="line">  <span class="keyword">var</span> m_window_removeEventListener = <span class="built_in">window</span>.removeEventListener;</div><div class="line"></div><div class="line">  <span class="comment">// 缓存所有的事件处理函数</span></div><div class="line">  <span class="keyword">var</span> documentEventHandlers = &#123;&#125;,</div><div class="line">      windowEventHandlers = &#123;&#125;;</div><div class="line">  </div><div class="line">  <span class="comment">// 重新定义addEventListener、removeEventListener，方便后面注册添加pause、resume、deviceReady等事件</span></div><div class="line">  <span class="built_in">document</span>.addEventListener = <span class="function"><span class="keyword">function</span>(<span class="params">evt, handler, capture</span>) </span>&#123;...&#125;</div><div class="line">  <span class="built_in">window</span>.addEventListener = <span class="function"><span class="keyword">function</span>(<span class="params">evt, handler, capture</span>) </span>&#123;...&#125;</div><div class="line">  <span class="built_in">document</span>.removeEventListener = <span class="function"><span class="keyword">function</span>(<span class="params">evt, handler, capture</span>) </span>&#123;...&#125;</div><div class="line">  <span class="built_in">window</span>.removeEventListener = <span class="function"><span class="keyword">function</span>(<span class="params">evt, handler, capture</span>) </span>&#123;...&#125;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createEvent</span>(<span class="params">type, data</span>) </span>&#123;...&#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> cordova = &#123;</div><div class="line">    <span class="attr">define</span>: define,</div><div class="line">    <span class="attr">require</span>: <span class="built_in">require</span>,</div><div class="line">    <span class="attr">version</span>: PLATFORM_VERSION_BUILD_LABEL,</div><div class="line">    <span class="attr">platformVersion</span>: PLATFORM_VERSION_BUILD_LABEL,</div><div class="line">    <span class="attr">platformId</span>: platform.id,</div><div class="line">    <span class="attr">addWindowEventHandler</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;...&#125;,</div><div class="line">    <span class="attr">addStickyDocumentEventHandler</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;...&#125;,</div><div class="line">    <span class="attr">addDocumentEventHandler</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;...&#125;,</div><div class="line">    <span class="attr">removeWindowEventHandler</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;...&#125;,</div><div class="line">    <span class="attr">removeDocumentEventHandler</span>: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;...&#125;,</div><div class="line">    <span class="attr">getOriginalHandlers</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;...&#125;,</div><div class="line">    <span class="attr">fireDocumentEvent</span>: <span class="function"><span class="keyword">function</span>(<span class="params">type, data, bNoDetach</span>) </span>&#123;...&#125;,</div><div class="line">    <span class="attr">fireWindowEvent</span>: <span class="function"><span class="keyword">function</span>(<span class="params">type, data</span>) </span>&#123;...&#125;,</div><div class="line">    <span class="attr">callbackId</span>: <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">2000000000</span>),</div><div class="line">    <span class="attr">callbacks</span>: &#123;&#125;,</div><div class="line">    <span class="attr">callbackStatus</span>: &#123;&#125;,</div><div class="line">    <span class="attr">callbackSuccess</span>: <span class="function"><span class="keyword">function</span>(<span class="params">callbackId, args</span>) </span>&#123;...&#125;,</div><div class="line">    <span class="attr">callbackError</span>: <span class="function"><span class="keyword">function</span>(<span class="params">callbackId, args</span>) </span>&#123;...&#125;,</div><div class="line">    <span class="attr">callbackFromNative</span>: <span class="function"><span class="keyword">function</span>(<span class="params">callbackId, isSuccess, status, args, keepCallback</span>) </span>&#123;...&#125;,</div><div class="line">    <span class="attr">addConstructor</span>: <span class="function"><span class="keyword">function</span>(<span class="params">func</span>) </span>&#123;...&#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 暴露cordova对象给外部</span></div><div class="line">  <span class="built_in">module</span>.exports = cordova;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这里我们以document Event为例说明一下cordova模块中关于事件的处理：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 保存addEventListener、removeEventListener的原生实现</span></div><div class="line"><span class="keyword">var</span> m_document_addEventListener = <span class="built_in">document</span>.addEventListener;</div><div class="line"><span class="keyword">var</span> m_document_removeEventListener = <span class="built_in">document</span>.removeEventListener;</div><div class="line"><span class="comment">// 缓存事件处理函数</span></div><div class="line"><span class="keyword">var</span> documentEventHandlers = &#123;&#125;;</div><div class="line"><span class="comment">// 重新定义addEventListener</span></div><div class="line"><span class="built_in">document</span>.addEventListener = <span class="function"><span class="keyword">function</span>(<span class="params">evt, handler, capture</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> e = evt.toLowerCase();</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> documentEventHandlers[e] != <span class="string">'undefined'</span>) &#123;</div><div class="line">        documentEventHandlers[e].subscribe(handler);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        m_document_addEventListener.call(<span class="built_in">document</span>, evt, handler, capture);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 重新定义removeEventListener</span></div><div class="line"><span class="built_in">document</span>.removeEventListener = <span class="function"><span class="keyword">function</span>(<span class="params">evt, handler, capture</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> e = evt.toLowerCase();</div><div class="line">    <span class="comment">// If unsubscribing from an event that is handled by a plugin</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> documentEventHandlers[e] != <span class="string">"undefined"</span>) &#123;</div><div class="line">        documentEventHandlers[e].unsubscribe(handler);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        m_document_removeEventListener.call(<span class="built_in">document</span>, evt, handler, capture);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 创建 Event 对象</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createEvent</span>(<span class="params">type, data</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> event = <span class="built_in">document</span>.createEvent(<span class="string">'Events'</span>);</div><div class="line">    event.initEvent(type, <span class="literal">false</span>, <span class="literal">false</span>);</div><div class="line">    <span class="keyword">if</span> (data) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> data) &#123;</div><div class="line">            <span class="keyword">if</span> (data.hasOwnProperty(i)) &#123;</div><div class="line">                event[i] = data[i];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> event;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> codova = &#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 创建事件通道</span></div><div class="line">    addStickyDocumentEventHandler:<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> (documentEventHandlers[event] = channel.createSticky(event));</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">addDocumentEventHandler</span>:<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> (documentEventHandlers[event] = channel.create(event));</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 取消事件通道</span></div><div class="line">    removeDocumentEventHandler:<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">        <span class="keyword">delete</span> documentEventHandlers[event];</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 发布事件消息</span></div><div class="line">    fireDocumentEvent: <span class="function"><span class="keyword">function</span>(<span class="params">type, data, bNoDetach</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> evt = createEvent(type, data);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> documentEventHandlers[type] != <span class="string">'undefined'</span>) &#123;</div><div class="line">            <span class="keyword">if</span>( bNoDetach ) &#123;</div><div class="line">                documentEventHandlers[type].fire(evt);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                    <span class="comment">// Fire deviceready on listeners that were registered before cordova.js was loaded.</span></div><div class="line">                    <span class="keyword">if</span> (type == <span class="string">'deviceready'</span>) &#123;</div><div class="line">                        <span class="built_in">document</span>.dispatchEvent(evt);</div><div class="line">                    &#125;</div><div class="line">                    documentEventHandlers[type].fire(evt);</div><div class="line">                &#125;, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">document</span>.dispatchEvent(evt);</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="built_in">module</span>.exports = cordova;</div></pre></td></tr></table></figure></p>
<p>在初始化启动模块<code>cordova/init</code>中有这样的代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 注册pause、resume、deviceReady事件</span></div><div class="line">channel.onPause = cordova.addDocumentEventHandler(<span class="string">'pause'</span>);</div><div class="line">channel.onResume = cordova.addDocumentEventHandler(<span class="string">'resume'</span>);</div><div class="line">channel.onActivated = cordova.addDocumentEventHandler(<span class="string">'activated'</span>);</div><div class="line">channel.onDeviceReady = cordova.addStickyDocumentEventHandler(<span class="string">'deviceready'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 监听DOMContentLoaded事件并发布事件消息</span></div><div class="line"><span class="keyword">if</span> (<span class="built_in">document</span>.readyState == <span class="string">'complete'</span> || <span class="built_in">document</span>.readyState == <span class="string">'interactive'</span>) &#123;</div><div class="line">    channel.onDOMContentLoaded.fire();</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">'DOMContentLoaded'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        channel.onDOMContentLoaded.fire();</div><div class="line">    &#125;, <span class="literal">false</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 原生层加载完成事件</span></div><div class="line"><span class="keyword">if</span> (<span class="built_in">window</span>._nativeReady) &#123;</div><div class="line">    channel.onNativeReady.fire();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 加载完成发布时间事件消息</span></div><div class="line">channel.join(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    modulemapper.mapModules(<span class="built_in">window</span>);</div><div class="line">    platform.initialize &amp;&amp; platform.initialize();</div><div class="line">    channel.onCordovaReady.fire();</div><div class="line">    channel.join(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">require</span>(<span class="string">'cordova'</span>).fireDocumentEvent(<span class="string">'deviceready'</span>);</div><div class="line">    &#125;, channel.deviceReadyChannelsArray);</div><div class="line">&#125;, platformInitChannelsArray);</div></pre></td></tr></table></figure></p>
<p>这里通过addDocumentEventHandler及addStickyDocumentEventHandler创建了事件通道，并通过fireDocumentEvent或者fire发布事件消息，这样我们就可以通过document.addEventListener订阅监听事件了。</p>
<p>如果我们要创建一个自定义事件Test,我们可以这样做：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建事件通道</span></div><div class="line">cordova.addWindowEventHandler(<span class="string">'Test'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 发布事件消息</span></div><div class="line">cordova.fireWindowEvent(<span class="string">'Test'</span>, &#123;</div><div class="line">    <span class="attr">name</span>: <span class="string">'test'</span>,</div><div class="line">    <span class="attr">data</span>: &#123;</div><div class="line">        <span class="attr">time</span>: <span class="keyword">new</span> <span class="built_in">Date</span>()</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// 订阅事件消息</span></div><div class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'Test'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</div><div class="line">     <span class="built_in">console</span>.log(evt);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://rensanning.iteye.com/blog/2163892" target="_blank" rel="external">Cordova 3.x 入门 - 目录</a><br><a href="http://www.cnblogs.com/linjisong/archive/2012/08/16/2642233.html" target="_blank" rel="external">PhoneGap源码分析</a></p>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><p>本文至此已经说完了cordova的模块机制和事件机制，已经cordova的工具模块，了解这些后写起插件来才能得心应手，对于原理实现部分不属于本文的范畴，下一篇会详细讲解cordova原理实现。敬请关注，不过近来在写毕设，估计一时半会儿也不会写完，本文前前后后已是拖了半个月。如果觉得本文对您有帮助，不妨打赏支持。</p>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2017-05-08T05:43:46.652Z" itemprop="dateUpdated">2017-05-08 13:43:46</time>
</span><br>


        
        转载需标注本文原始地址：<a href="/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/" target="_blank" rel="external">https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/</a>
        
    </div>
    <footer>
        <a href="https://zhaomenghuan.github.io">
            <img src="/img/avatar.png" alt="赵梦欢">
            赵梦欢
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cordova/">cordova</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hybrid-App/">hybrid App</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/&title=《cordova研习笔记(二) —— cordova 6.X 源码解读》 — 小青年博客&pic=https://zhaomenghuan.github.io/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/&title=《cordova研习笔记(二) —— cordova 6.X 源码解读》 — 小青年博客&source=小青年,小青年博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《cordova研习笔记(二) —— cordova 6.X 源码解读》 — 小青年博客&url=https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/&via=https://zhaomenghuan.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2017/05/12/Linux CentOS7 搭建node服务详细教程/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Linux CentOS7 搭建node服务详细教程</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2017/04/26/cordova研习笔记(一) ——初试牛刀之cordova.js概要/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">cordova研习笔记(一) —— 初试牛刀之cordova.js概要</h4>
      </a>
    </div>
  
</nav>



    













</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        感谢老铁~
        <i class="icon icon-quote-right"></i>
    </h3>
    <ul class="reward-items">
        
        <li>
            <img src="/img/wechat.png" title="微信打赏二维码" alt="微信打赏二维码">
            <p>微信</p>
        </li>
        

        
        <li>
            <img src="/img/alipay.png" title="支付宝打赏二维码" alt="支付宝打赏二维码">
            <p>支付宝</p>
        </li>
        
    </ul>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p>
            <span>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></span>
            <span>赵梦欢 &copy; 2015 - 2017</span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/&title=《cordova研习笔记(二) —— cordova 6.X 源码解读》 — 小青年博客&pic=https://zhaomenghuan.github.io/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/&title=《cordova研习笔记(二) —— cordova 6.X 源码解读》 — 小青年博客&source=小青年,小青年博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《cordova研习笔记(二) —— cordova 6.X 源码解读》 — 小青年博客&url=https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/&via=https://zhaomenghuan.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://zhaomenghuan.github.io/2017/05/04/cordova研习笔记(二)——cordova 6.X 源码解读（上）/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADNklEQVR42u3aS24bQQwFQN//0g6QVRYe6T22HGiompVhwT2s9oLi5+srfr7/Psmnyc///ib/26sYHsd29GBjY2PfhP398HkcRAJL3vWYl78lsWBjY2NvZSdpqX3943SVv+skqsvfY2NjY38k+3EqygEnya89BxsbGxu7bQDlbam2pJkVKtjY2Nifw87bPcmns+HBSRr7xV4aNjY29tuz20HvO//8i/NtbGxs7Ldkf5dPe1pb2JyPnKNzsLGxsRex86/7s1Qxu6yTdlVxAjY2NvYKdrtSmY9a89Dz1tWs1qhfiY2NjX1b9uxSZqklWa9sl4HyUgcbGxt7E7vtnJ8MVtskN4thOO7FxsbGXsE+HwbkazdtkdM2uZKSCRsbG3s3e7bf0l5fXTAcLBhFGRsbGxv7huwk9Lzt3g5l85TWDi2eXDE2Njb2InaeTs7XH9uw2kQ4HGxgY2NjL2InqWuWJNrE1jb6z4sibGxs7Puyk2Lj/y/ZtFG1F4eNjY29if2qoGfJZtboby/iMmZsbGzsFew8Ic2WcvLmUV6E5Os+Twa92NjY2B/Ani305KHkgc7Gw5cibGxs7EXs8wIgL0LaAW2+JHSSULGxsbHvzm5bPHmZ0RYPLSkfJ1w2lbCxsbFXsF/VvmmHrG16y88p2mHY2NjYK9h52ZCXJXno7fA4XyF6UpZgY2NjL2InH89CnF1H2/A66pxhY2NjL2In4bYrle0VJCfP2kyXMWBjY2OvYLfI88JgNlpuE9WTE7CxsbGXspME1n7Dz0N/XGAkCayoOLCxsbHXsfMv+m3obdB5ukredflX2NjY2IvYeapo127a8W17xfk/4PIEbGxs7BXsPKnM2kyz1k87mc2T6w95GxsbG3sFOy8McvxJ0PmnwwcbGxt7HXtGOg8uL1dmFxqVItjY2Ng3Z5+nunZscLJY2SbdWcGDjY2NfUd23iqatebboUJenLSprsje2NjY2Ddkt4CW+qqLmCXdH87BxsbG/kj2q2CzFJU3wqLEho2Njf3B7JP20Mkl5ktCUf8MGxsbex37/OhZ2dC2q17WkMLGxsZexD5p0OQH5cs3SVI8KU6wsbGxF7H/AIToESTAYTDbAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };



lazyScripts.push('//s95.cnzz.com/z_stat.php?id=1261860158&web_id=1261860158')

</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '小青年博客！';
            clearTimeout(titleTime);
        } else {
            document.title = '看似寻常最奇崛，成如容易却艰辛。';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



<script type="text/javascript">
    (function(p,u,s,h){
        p._pcq=p._pcq||[];
        p._pcq.push(['_currentTime',Date.now()]);
        s=u.createElement('script');
        s.type='text/javascript';
        s.async=true;
        s.src='https://cdn.pushcrew.com/js/84781173feeb9c46759523538d7dbfe0.js';
        h=u.getElementsByTagName('script')[0];
        h.parentNode.insertBefore(s,h);
    })(window,document);
</script>

</body>
</html>
